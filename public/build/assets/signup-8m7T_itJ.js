function C(){document.querySelectorAll("#signupForm .form-group").forEach(d=>{const o=d.querySelector("input[required], select[required], textarea[required]"),u=d.querySelector("label");if(o&&!o.disabled&&u&&!u.querySelector(".text-danger")){const m=document.createElement("span");m.className="text-danger",m.textContent=" *",u.appendChild(m)}})}const O=new Date("2026-03-01T00:00:00");function W(){const d=document.getElementById("signupForm"),o=document.getElementById("deadlineAlert");if(!d)return;const m=new Date>=O;o&&o.classList.toggle("d-none",!m),m&&d.querySelectorAll("input, select, textarea, button").forEach(p=>{p.type!=="hidden"&&(p.disabled=!0)})}let L=0;function D(d){const o=`mother_${d}`;return`
        <div class="mother-fields" data-mother-index="${d}" style="border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 5px; background-color: #f9f9f9;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h4 style="margin: 0; font-size: 1rem; color: #555;">معلومات الزوجة ${d>0?d:""}</h4>
                ${d>0?'<button type="button" class="remove-mother-btn" style="background-color: #dc3545; color: white; border: none; padding: 0.3rem 0.8rem; border-radius: 3px; cursor: pointer;">حذف</button>':""}
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="${o}_nin">الرقم الوطني للأم (NIN) <span class="text-danger">*</span></label>
                    <input type="number" id="${o}_nin" name="${o}_nin" required maxlength="18" inputmode="numeric">
                </div>
                <div class="form-group">
                    <label for="${o}_nss">الرقم الوطني للضمان الاجتماعي للأم (NSS) <span class="text-danger">*</span></label>
                    <input type="text" id="${o}_nss" name="${o}_nss" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="${o}_nom_ar">لقب الأم بالعربية <span class="text-danger">*</span></label>
                    <input type="text" id="${o}_nom_ar" name="${o}_nom_ar" required>
                </div>
                <div class="form-group">
                    <label for="${o}_prenom_ar">اسم الأم بالعربية <span class="text-danger">*</span></label>
                    <input type="text" id="${o}_prenom_ar" name="${o}_prenom_ar" required>
                </div>
            </div>
            
            <div class="form-group">
                <label for="${o}_categorie_sociale">الفئة الاجتماعية <span class="text-danger">*</span></label>
                <select id="${o}_categorie_sociale" name="${o}_categorie_sociale" required>
                    <option value="" disabled selected>اختر الفئة الاجتماعية</option>
                    <option value="عديم الدخل">عديم الدخل</option>
                    <option value="الدخل الشهري أقل أو يساوي مبلغ الأجر الوطني الأدنى المضمون">الدخل الشهري أقل أو يساوي مبلغ الأجر الوطني الأدنى المضمون</option>
                </select>
            </div>
            
            <div class="form-group" id="${o}_montant_wrapper" style="display: none;">
                <label for="${o}_montant_s">مبلغ الدخل الشهري <span class="text-danger">*</span></label>
                <input type="number" id="${o}_montant_s" name="${o}_montant_s">
            </div>
        </div>
    `}function P(){L++;const d=document.getElementById("mothers-container");if(!d)return;const o=D(L);d.insertAdjacentHTML("beforeend",o);const u=d.querySelector(`[data-mother-index="${L}"] .remove-mother-btn`);u&&u.addEventListener("click",function(){this.closest(".mother-fields").remove()});const m=document.getElementById(`mother_${L}_categorie_sociale`),p=document.getElementById(`mother_${L}_montant_wrapper`),f=document.getElementById(`mother_${L}_montant_s`);m&&p&&f&&m.addEventListener("change",function(){this.value==="الدخل الشهري أقل أو يساوي مبلغ الأجر الوطني الأدنى المضمون"?(p.style.display="block",f.required=!0):(p.style.display="none",f.required=!1,f.value="")}),C()}document.addEventListener("DOMContentLoaded",()=>{const d=document.getElementById("mothers-container");if(d){L=0,d.innerHTML=D(0);const t=document.getElementById("mother_0_categorie_sociale"),r=document.getElementById("mother_0_montant_wrapper"),n=document.getElementById("mother_0_montant_s");t&&r&&n&&t.addEventListener("change",function(){this.value==="الدخل الشهري أقل أو يساوي مبلغ الأجر الوطني الأدنى المضمون"?(r.style.display="block",n.required=!0):(r.style.display="none",n.required=!1,n.value="")})}const o=document.getElementById("add-mother-btn");o&&o.addEventListener("click",P);const u=document.getElementById("wilayaSelectSignup"),m=document.getElementById("communeSelectSignup");if(u&&m){async function t(){try{u.innerHTML='<option value="">جارٍ التحميل...</option>';const e=await(await fetch("/api/wilayas")).json(),s=Array.isArray(e)?e:e.data||[];u.innerHTML='<option value="">اختر...</option>',Array.isArray(s)&&s.forEach(l=>{u.innerHTML+=`<option value="${l.code_wil}">${l.lib_wil_ar}</option>`})}catch(n){console.error("خطأ في تحميل الولايات:",n),u.innerHTML='<option value="">تعذر تحميل البيانات</option>'}}async function r(n){try{m.innerHTML='<option value="">جارٍ التحميل...</option>',m.disabled=!0;const s=await(await fetch(`/api/communes/by-wilaya/${n}`)).json(),l=Array.isArray(s)?s:s.data||[];m.innerHTML='<option value="">اختر...</option>',Array.isArray(l)&&l.forEach(a=>{m.innerHTML+=`<option value="${a.code_comm}">${a.lib_comm_ar}</option>`}),m.disabled=!1}catch(e){console.error("خطأ في تحميل البلديات:",e),m.innerHTML='<option value="">تعذر تحميل البيانات</option>'}}u.addEventListener("change",n=>{const e=n.target.value;e?r(e):(m.innerHTML='<option value="">اختر الولاية أولا...</option>',m.disabled=!0)}),t()}const p=document.getElementById("wilaya_carte"),f=document.getElementById("commune_carte");if(p&&f){async function t(){try{p.innerHTML='<option value="">جارٍ التحميل...</option>';const e=await(await fetch("/api/wilayas")).json(),s=Array.isArray(e)?e:e.data||[];p.innerHTML='<option value="">-- اختر الولاية --</option>',Array.isArray(s)&&s.forEach(l=>p.innerHTML+=`<option value="${l.code_wil}">${l.lib_wil_ar}</option>`)}catch(n){console.error("خطأ في تحميل ولايات البطاقة:",n),p.innerHTML='<option value="">تعذر تحميل البيانات</option>'}}async function r(n){try{f.innerHTML='<option value="">جارٍ التحميل...</option>',f.disabled=!0;const s=await(await fetch(`/api/communes/by-wilaya/${n}`)).json(),l=Array.isArray(s)?s:s.data||[];f.innerHTML='<option value="">-- اختر البلدية --</option>',Array.isArray(l)&&l.forEach(a=>f.innerHTML+=`<option value="${a.code_comm}">${a.lib_comm_ar}</option>`),f.disabled=!1}catch(e){console.error("خطأ في تحميل بلديات البطاقة:",e),f.innerHTML='<option value="">تعذر تحميل البيانات</option>'}}p.addEventListener("change",n=>{const e=n.target.value;e?r(e):(f.innerHTML='<option value="">اختر الولاية أولا...</option>',f.disabled=!0)}),t()}C();const x=document.querySelectorAll(".form-step"),H=document.querySelectorAll(".next-step"),T=document.querySelectorAll(".prev-step"),F=document.getElementById("progress"),B=document.querySelectorAll(".progress-step");let y=0;function A(){x.forEach((t,r)=>t.classList.toggle("active",r===y)),B.forEach((t,r)=>t.classList.toggle("active",r<=y)),F.style.width=y/(B.length-1)*100+"%",k(),N()}function b(t,r){if(v(t),!r)return;const n=document.createElement("div");n.className="error-message",n.textContent=r,(t.closest(".password-wrapper")||t).insertAdjacentElement("afterend",n),t.classList.add("invalid"),t.classList.remove("valid")}function M(t){v(t),t.classList.add("valid"),t.classList.remove("invalid")}function v(t){(t.closest(".password-wrapper")||t).parentNode.querySelectorAll(".error-message").forEach(e=>e.remove())}function $(t,r=!0){if(t.disabled)return v(t),t.classList.remove("invalid","valid"),!0;const n=t.value.trim(),e=t.id,s=t.type,l=t.name;v(t);let a=!0,c="";if(s==="radio"){const E=document.querySelectorAll(`input[name="${l}"]`),q=document.querySelector(`input[name="${l}"]:checked`),_=t.closest(".form-group");if(_&&_.querySelectorAll(".error-message").forEach(i=>i.remove()),!q&&(a=!1,c="هذا الحقل مطلوب",r&&_)){const i=document.createElement("div");i.className="error-message",i.textContent=c,_.appendChild(i)}return E.forEach(i=>{i.classList.toggle("valid",a),i.classList.toggle("invalid",!a)}),a}if(t.tagName.toLowerCase()==="select"&&t.hasAttribute("required")&&(n===""||n==="none")&&(a=!1,c="هذا الحقل مطلوب"),t.hasAttribute("required")&&n===""&&(a=!1,c="هذا الحقل مطلوب"),a&&n!=="")switch(e){case"nin":/^\d{18}$/.test(n)||(a=!1,c="يجب أن يحتوي الرقم التعريفي الوطني على 18 رقمًا بالضبط");break;case"email":/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(n)||(a=!1,c="البريد الإلكتروني غير صالح");break;case"phone":/^\d{10}$/.test(n)||(a=!1,c="رقم الهاتف يجب أن يحتوي على 10 أرقام");break;case"password":/^(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&]).{8,}$/.test(n)||(a=!1,c="كلمة المرور ضعيفة، يجب أن تحتوي على حرف كبير، رقم، ورمز خاص");break;case"confirm_password":const E=document.getElementById("password").value;n!==E&&(a=!1,c="كلمة المرور غير مطابقة");break;case"date_naissance":const q=new Date;new Date(n)>q&&(a=!1,c="تاريخ الميلاد لا يمكن أن يكون في المستقبل");break;case"num_carte":/^\d{9}$/.test(n)||(a=!1,c="يجب أن يحتوي رقم بطاقة التعريف الوطنية على 9 أرقام");break;case"date_carte":const i=new Date;i.setHours(0,0,0,0),new Date(n)>i&&(a=!1,c="تاريخ إصدار البطاقة يجب أن يكون قبل أو يساوي تاريخ اليوم");break;case"nss":/^\d{12}$/.test(n)||(a=!1,c="الرقم الوطني للضمان الاجتماعي يجب أن يحتوي على 12 رقمًا بالضبط");break;case"montant_s":if(document.getElementById("categorie_sociale").value!=="عديم الدخل"){const h=parseFloat(n);isNaN(h)||h<=0?(a=!1,c="يرجى إدخال مبلغ صالح (أكبر من 0)"):t.value=h}else t.value="0",a=!0,v(t);break;case"num_cp":/^\d{10}$/.test(n)||(a=!1,c="رقم الحساب البريدي يجب أن يحتوي على 10 أرقام");break;case"cle_ccp":/^\d{2}$/.test(n)||(a=!1,c="الرقم المفتاح يجب أن يحتوي على رقمين اثنين");break}return a?M(t):r?b(t,c):t.classList.remove("valid","invalid"),a}const I=document.getElementById("phone");I&&I.addEventListener("input",function(){const t=this.value.replace(/\D/g,"");this.value!==t?b(this,"يجب إدخال أرقام فقط"):t.length>0&&t.length!==10?b(this,"رقم الهاتف يجب أن يحتوي على 10 أرقام"):(v(this),this.classList.add("valid"),this.classList.remove("invalid")),this.value=t.slice(0,10)}),["nom_ar","prenom_ar"].forEach(t=>{const r=document.getElementById(t);if(!r)return;const n=/^[\u0600-\u06FF\s]+$/;r.addEventListener("keypress",function(e){const s=e.key;/^[\u0600-\u06FF\s]$/.test(s)||(e.preventDefault(),b(this,"يرجى الإدخال باللغة العربية فقط"),this.classList.add("invalid"),this.classList.remove("valid"))}),r.addEventListener("input",function(){const e=this.value.trim();if(e===""){v(this),this.classList.remove("valid","invalid");return}n.test(e)?(v(this),this.classList.add("valid"),this.classList.remove("invalid")):(b(this,"يرجى الإدخال باللغة العربية فقط"),this.classList.add("invalid"),this.classList.remove("valid"))})}),["nom_fr","prenom_fr"].forEach(t=>{const r=document.getElementById(t);if(!r)return;const n=/^[A-Za-zÀ-ÿ\s]+$/;r.addEventListener("keypress",function(e){const s=e.key;/^[\u0600-\u06FF]$/.test(s)&&(e.preventDefault(),b(this,"يرجى الإدخال بالحروف اللاتينية فقط"),this.classList.add("invalid"),this.classList.remove("valid"))}),r.addEventListener("input",function(){const e=this.value.trim();if(e===""){v(this),this.classList.remove("valid","invalid");return}n.test(e)?(v(this),this.classList.add("valid"),this.classList.remove("invalid")):(b(this,"يرجى الإدخال بالحروف اللاتينية فقط"),this.classList.add("invalid"),this.classList.remove("valid"))})});function k(){const t=document.querySelectorAll(".form-step.active input, .form-step.active select"),r=document.getElementById("categorie_sociale"),n=document.getElementById("montant_s");r&&n&&(r.removeEventListener("change",r._changeHandler),r._changeHandler=function(){this.value==="1"?(n.removeAttribute("disabled"),n.setAttribute("required","required"),n.value=""):(n.value="0",n.setAttribute("disabled","disabled"),n.removeAttribute("required"),n.classList.remove("valid","invalid"),v(n))},r.addEventListener("change",r._changeHandler),r._changeHandler()),t.forEach(e=>{e.removeEventListener("input",e._inputHandler),e.removeEventListener("blur",e._blurHandler),e.id==="nin"&&e.addEventListener("input",()=>{e.value=e.value.replace(/\D/g,"").slice(0,18)}),e.id==="num_carte"&&e.addEventListener("input",()=>{e.value=e.value.replace(/\D/g,"").slice(0,9)}),e.id==="nss"&&e.addEventListener("input",()=>{e.value=e.value.replace(/\D/g,"").slice(0,12)}),e.id==="montant_s"&&e.addEventListener("input",()=>{parseFloat(e.value)<0&&(e.value="")}),e.id==="num_cp"&&e.addEventListener("input",()=>{e.value=e.value.replace(/\D/g,"").slice(0,10)}),e.id==="cle_ccp"&&e.addEventListener("input",()=>{e.value=e.value.replace(/\D/g,"").slice(0,2)}),e._inputHandler=()=>{e.value.trim()!==""&&$(e,!1)},e.addEventListener("input",e._inputHandler),e._blurHandler=()=>{e.value.trim()!==""&&$(e,!0)},e.addEventListener("blur",e._blurHandler)})}function N(){const t=document.getElementById("categorie_sociale"),r=document.getElementById("montant_s");t.value==="2"||t.value===""?(r.value="0",r.setAttribute("disabled",!0),r.removeAttribute("required"),v(r)):(r.removeAttribute("disabled"),r.setAttribute("required","required"),r.value==="0"&&(r.value=""))}function j(){const t=document.querySelector(".form-step.active"),r=t.querySelectorAll("input[required], select[required]");let n=!0,e=[];return t.querySelectorAll(".error-message").forEach(s=>s.remove()),r.forEach(s=>{if(!$(s,!0)){n=!1;const l=s.closest(".form-group")?.querySelector("label")?.textContent||s.name;e.push(l)}}),r.forEach(s=>{if(!(s.disabled&&s.id!=="montant_s")&&!$(s,!0)){n=!1;const l=s.closest(".form-group")?.querySelector("label")?.textContent||s.name;e.includes(l)||e.push(l)}}),!n&&typeof Swal<"u"&&Swal.fire({icon:"warning",title:"يرجى إكمال البيانات",html:`الحقول التالية مطلوبة أو تحتوي على أخطاء:<br><b>${e.join("<br>")}</b>`,confirmButtonText:"حسنًا"}),n}H.forEach(t=>{t.addEventListener("click",()=>{(y===0||y===1)&&!j()||y<x.length-1&&(y++,A())})}),T.forEach(t=>{t.addEventListener("click",()=>{y>0&&(y--,A())})});const S=document.getElementById("signupForm");function R(t,r){if(t=t.trim(),r=r.trim(),!/^\d+$/.test(t)||!/^\d+$/.test(r))return!1;const e=parseInt(t,10)*100%97,l=(97-(e+85>97?e+85-97:e+85)).toString().padStart(2,"0");return r===l}S&&(S.noValidate=!0,S.addEventListener("submit",async t=>{t.preventDefault();let r=!0,n=[];document.querySelectorAll(".error-message").forEach(i=>i.remove()),S.querySelectorAll("input[required], select[required]").forEach(i=>{if(!$(i,!0)){r=!1;const w=i.closest(".form-group, .col-md-3")?.querySelector("label")?.textContent||i.name;n.includes(w)||n.push(w)}});const s=S.querySelector('input[name="gender"]:checked');s||(r=!1,n.includes("الجنس")||n.push("الجنس"));const l=document.getElementById("agreement_checkbox");if(!l||!l.checked?(r=!1,n.includes("الموافقة على القوانين")||n.push("الموافقة على القوانين"),l&&(l.style.outline="2px solid #ef4444",l.style.outlineOffset="2px")):l&&(l.style.outline="",l.style.outlineOffset=""),!r){Swal.fire({icon:"warning",title:"يرجى إكمال البيانات",html:`الحقول التالية مطلوبة أو تحتوي على أخطاء:<br><b>${n.join("<br>")}</b>`,confirmButtonText:"حسنًا"});return}const a=Object.fromEntries(new FormData(S).entries()),c={nin:a.nin,email:a.email,tel:a.phone,password:a.password,nom_ar:a.nom_ar,prenom_ar:a.prenom_ar,nom_fr:a.nom_fr,prenom_fr:a.prenom_fr,sexe:s.value==="male"?"ذكر":"أنثى",date_naiss:a.date_naissance,presume:a.presume?"1":"0",commune_naiss:document.getElementById("communeSelectSignup")?.value||null,adresse:a.adresse,nbr_enfants_scolarise:a.nbr_enfants,num_cni:a.num_carte,date_cni:a.date_carte,lieu_cni:document.getElementById("commune_carte")?.value||null,nss:a.nss,num_cpt:a.num_cp,cle_cpt:a.cle_ccp,cats:a.categorie_sociale,montant_s:a.montant_s,autr_info:a.autre_info||"",code_commune:document.getElementById("communeSelectSignup")?.value||null},E=[];if(document.querySelectorAll(".mother-fields").forEach((i,w)=>{const g=i.dataset.motherIndex,h={nin:a[`mother_${g}_nin`],nss:a[`mother_${g}_nss`],nom_ar:a[`mother_${g}_nom_ar`],prenom_ar:a[`mother_${g}_prenom_ar`],categorie_sociale:a[`mother_${g}_categorie_sociale`],montant_s:a[`mother_${g}_montant_s`]||null};h.nin&&h.nss&&h.nom_ar&&h.prenom_ar&&h.categorie_sociale&&E.push(h)}),E.length>0&&(c.mothers=E),!R(c.num_cpt,c.cle_cpt)){Swal.fire({icon:"warning",title:" CCP خطأ في",text:"رقم CCP أو مفتاح CCP غير صحيح. يرجى التحقق.",confirmButtonText:"حسنًا"});return}const _=new FormData;for(const i in c)c[i]!==void 0&&c[i]!==null&&(i==="mothers"&&Array.isArray(c[i])?_.append(i,JSON.stringify(c[i])):_.append(i,c[i]));try{Swal.fire({title:"جاري الإرسال...",text:"الرجاء الانتظار قليلاً",allowOutsideClick:!1,didOpen:()=>Swal.showLoading()});const i=await fetch("/api/tuteurs",{method:"POST",body:_,headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content,Accept:"application/json"}}),w=await i.json();if(Swal.close(),i.status===422){const g=Object.values(w.errors||{}).flat().join("<br>");Swal.fire({icon:"warning",title:"تحقق من البيانات",html:g,confirmButtonText:"حسنًا",customClass:{confirmButton:"swal-confirm-btn"},buttonsStyling:!1});return}if(!i.ok){Swal.fire({icon:"error",title:"حدث خطأ أثناء التسجيل",text:w.message||"يرجى المحاولة لاحقًا.",confirmButtonText:"حسنًا",customClass:{confirmButton:"swal-confirm-btn"},buttonsStyling:!1});return}Swal.fire({icon:"success",title:"✅ تم التسجيل بنجاح!",text:"يمكنك الآن تسجيل الدخول إلى حسابك.",confirmButtonText:"حسنًا",customClass:{confirmButton:"swal-confirm-btn"},buttonsStyling:!1}).then(()=>{window.location.href="/login"})}catch(i){console.error("❌ Fetch error:",i),Swal.close(),Swal.fire({icon:"error",title:"خطأ في الاتصال بالخادم",text:"تحقق من الاتصال بالخادم المحلي أو الشبكة."})}})),W(),k(),A()});document.querySelectorAll(".toggle-password").forEach(d=>{d.addEventListener("click",()=>{const o=d.closest(".password-wrapper").querySelector("input");o.type==="password"?(o.type="text",d.classList.replace("fa-eye","fa-eye-slash")):(o.type="password",d.classList.replace("fa-eye-slash","fa-eye"))})});
