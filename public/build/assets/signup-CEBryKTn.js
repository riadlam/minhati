function D(){document.querySelectorAll("#signupForm .form-group").forEach(u=>{const o=u.querySelector("input[required], select[required], textarea[required]"),h=u.querySelector("label");if(o&&!o.disabled&&h&&!h.querySelector(".text-danger")){const m=document.createElement("span");m.className="text-danger",m.textContent=" *",h.appendChild(m)}})}const P=new Date("2026-03-01T00:00:00");function W(){const u=document.getElementById("signupForm"),o=document.getElementById("deadlineAlert");if(!u)return;const m=new Date>=P;o&&o.classList.toggle("d-none",!m),m&&u.querySelectorAll("input, select, textarea, button").forEach(y=>{y.type!=="hidden"&&(y.disabled=!0)})}let _=0;function M(u){const o=`mother_${u}`;return`
        <div class="mother-fields" data-mother-index="${u}" style="border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 5px; background-color: #f9f9f9;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h4 style="margin: 0; font-size: 1rem; color: #555;">معلومات الزوجة ${u>0?u:""}</h4>
                ${u>0?'<button type="button" class="remove-mother-btn" style="background-color: #dc3545; color: white; border: none; padding: 0.3rem 0.8rem; border-radius: 3px; cursor: pointer;">حذف</button>':""}
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="${o}_nin">الرقم الوطني للأم (NIN) <span class="text-danger">*</span></label>
                    <input type="text" id="${o}_nin" name="${o}_nin" required maxlength="18" inputmode="numeric" pattern="[0-9]{18}">
                </div>
                <div class="form-group">
                    <label for="${o}_nss">رقم الضمان الاجتماعي للأم (NSS) <span class="text-danger">*</span></label>
                    <input type="text" id="${o}_nss" name="${o}_nss" required maxlength="12" inputmode="numeric" pattern="[0-9]{12}">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="${o}_nom_ar">لقب الأم بالعربية <span class="text-danger">*</span></label>
                    <input type="text" id="${o}_nom_ar" name="${o}_nom_ar" required>
                </div>
                <div class="form-group">
                    <label for="${o}_prenom_ar">اسم الأم بالعربية <span class="text-danger">*</span></label>
                    <input type="text" id="${o}_prenom_ar" name="${o}_prenom_ar" required>
                </div>
            </div>
            
            <div class="form-group">
                <label for="${o}_categorie_sociale">الفئة الاجتماعية <span class="text-danger">*</span></label>
                <select id="${o}_categorie_sociale" name="${o}_categorie_sociale" required>
                    <option value="" disabled selected>اختر الفئة الاجتماعية</option>
                    <option value="عديم الدخل">عديم الدخل</option>
                    <option value="الدخل الشهري أقل أو يساوي مبلغ الأجر الوطني الأدنى المضمون">الدخل الشهري أقل أو يساوي مبلغ الأجر الوطني الأدنى المضمون</option>
                </select>
            </div>
            
            <div class="form-group" id="${o}_montant_wrapper" style="display: none;">
                <label for="${o}_montant_s">مبلغ الدخل الشهري <span class="text-danger">*</span></label>
                <input type="number" id="${o}_montant_s" name="${o}_montant_s">
            </div>
        </div>
    `}function J(){_++;const u=document.getElementById("mothers-container");if(!u)return;const o=M(_);u.insertAdjacentHTML("beforeend",o);const h=u.querySelector(`[data-mother-index="${_}"] .remove-mother-btn`);h&&h.addEventListener("click",function(){this.closest(".mother-fields").remove()});const m=document.getElementById(`mother_${_}_categorie_sociale`),y=document.getElementById(`mother_${_}_montant_wrapper`),p=document.getElementById(`mother_${_}_montant_s`);m&&y&&p&&m.addEventListener("change",function(){this.value==="الدخل الشهري أقل أو يساوي مبلغ الأجر الوطني الأدنى المضمون"?(y.style.display="block",p.required=!0):(y.style.display="none",p.required=!1,p.value="")}),window.setupMotherArabicValidation&&window.setupMotherArabicValidation(_),window.setupMotherNINValidation&&window.setupMotherNINValidation(_),window.setupMotherNSSValidation&&window.setupMotherNSSValidation(_),D()}document.addEventListener("DOMContentLoaded",()=>{const u=document.getElementById("mothers-container");if(u){_=0,u.innerHTML=M(0);const a=document.getElementById("mother_0_categorie_sociale"),t=document.getElementById("mother_0_montant_wrapper"),n=document.getElementById("mother_0_montant_s");a&&t&&n&&a.addEventListener("change",function(){this.value==="الدخل الشهري أقل أو يساوي مبلغ الأجر الوطني الأدنى المضمون"?(t.style.display="block",n.required=!0):(t.style.display="none",n.required=!1,n.value="")}),window.setupMotherArabicValidation&&window.setupMotherArabicValidation(0),window.setupMotherNINValidation&&window.setupMotherNINValidation(0),window.setupMotherNSSValidation&&window.setupMotherNSSValidation(0)}const o=document.getElementById("add-mother-btn");o&&o.addEventListener("click",J);const h=document.getElementById("wilayaSelectSignup"),m=document.getElementById("communeSelectSignup");if(h&&m){async function a(){try{h.innerHTML='<option value="">جارٍ التحميل...</option>';const e=await(await fetch("/api/wilayas")).json(),s=Array.isArray(e)?e:e.data||[];h.innerHTML='<option value="">اختر...</option>',Array.isArray(s)&&s.forEach(r=>{h.innerHTML+=`<option value="${r.code_wil}">${r.lib_wil_ar}</option>`})}catch(n){console.error("خطأ في تحميل الولايات:",n),h.innerHTML='<option value="">تعذر تحميل البيانات</option>'}}async function t(n){try{m.innerHTML='<option value="">جارٍ التحميل...</option>',m.disabled=!0;const s=await(await fetch(`/api/communes/by-wilaya/${n}`)).json(),r=Array.isArray(s)?s:s.data||[];m.innerHTML='<option value="">اختر...</option>',Array.isArray(r)&&r.forEach(i=>{m.innerHTML+=`<option value="${i.code_comm}">${i.lib_comm_ar}</option>`}),m.disabled=!1}catch(e){console.error("خطأ في تحميل البلديات:",e),m.innerHTML='<option value="">تعذر تحميل البيانات</option>'}}h.addEventListener("change",n=>{const e=n.target.value;e?t(e):(m.innerHTML='<option value="">اختر الولاية أولا...</option>',m.disabled=!0)}),a()}const y=document.getElementById("wilaya_carte"),p=document.getElementById("commune_carte");if(y&&p){async function a(){try{y.innerHTML='<option value="">جارٍ التحميل...</option>';const e=await(await fetch("/api/wilayas")).json(),s=Array.isArray(e)?e:e.data||[];y.innerHTML='<option value="">-- اختر الولاية --</option>',Array.isArray(s)&&s.forEach(r=>y.innerHTML+=`<option value="${r.code_wil}">${r.lib_wil_ar}</option>`)}catch(n){console.error("خطأ في تحميل ولايات البطاقة:",n),y.innerHTML='<option value="">تعذر تحميل البيانات</option>'}}async function t(n){try{p.innerHTML='<option value="">جارٍ التحميل...</option>',p.disabled=!0;const s=await(await fetch(`/api/communes/by-wilaya/${n}`)).json(),r=Array.isArray(s)?s:s.data||[];p.innerHTML='<option value="">-- اختر البلدية --</option>',Array.isArray(r)&&r.forEach(i=>p.innerHTML+=`<option value="${i.code_comm}">${i.lib_comm_ar}</option>`),p.disabled=!1}catch(e){console.error("خطأ في تحميل بلديات البطاقة:",e),p.innerHTML='<option value="">تعذر تحميل البيانات</option>'}}y.addEventListener("change",n=>{const e=n.target.value;e?t(e):(p.innerHTML='<option value="">اختر الولاية أولا...</option>',p.disabled=!0)}),a()}const x=document.getElementById("categorie_sociale"),I=document.getElementById("montant_s_wrapper"),$=document.getElementById("montant_s");x&&I&&$&&x.addEventListener("change",function(){this.value==="الدخل الشهري أقل أو يساوي مبلغ الأجر الوطني الأدنى المضمون"?(I.style.display="block",$.required=!0):(I.style.display="none",$.required=!1,$.value="")}),D();const A=document.querySelectorAll(".form-step"),F=document.querySelectorAll(".next-step"),H=document.querySelectorAll(".prev-step"),O=document.getElementById("progress"),B=document.querySelectorAll(".progress-step");let L=0;function q(){A.forEach((a,t)=>a.classList.toggle("active",t===L)),B.forEach((a,t)=>a.classList.toggle("active",t<=L)),O.style.width=L/(B.length-1)*100+"%",T(),V()}function f(a,t){if(c(a),!t)return;const n=document.createElement("div");n.className="error-message",n.textContent=t,(a.closest(".password-wrapper")||a).insertAdjacentElement("afterend",n),a.classList.add("invalid"),a.classList.remove("valid")}function j(a){c(a),a.classList.add("valid"),a.classList.remove("invalid")}function c(a){(a.closest(".password-wrapper")||a).parentNode.querySelectorAll(".error-message").forEach(e=>e.remove())}window.setupMotherArabicValidation=function(a){const t=document.getElementById(`mother_${a}_nom_ar`),n=document.getElementById(`mother_${a}_prenom_ar`);[t,n].forEach(e=>{if(!e)return;const s=/^[\u0600-\u06FF\s]+$/;e.addEventListener("keypress",function(r){const i=r.key;/^[\u0600-\u06FF\s]$/.test(i)||(r.preventDefault(),f(this,"يرجى الإدخال باللغة العربية فقط"),this.classList.add("invalid"),this.classList.remove("valid"))}),e.addEventListener("input",function(){const r=this.value.trim();if(r===""){c(this),this.classList.remove("valid","invalid");return}s.test(r)?(c(this),this.classList.add("valid"),this.classList.remove("invalid")):(f(this,"يرجى الإدخال باللغة العربية فقط"),this.classList.add("invalid"),this.classList.remove("valid"))}),e.addEventListener("blur",function(){const r=this.value.trim();if(r===""){c(this),this.classList.remove("valid","invalid");return}s.test(r)||(f(this,"يرجى الإدخال باللغة العربية فقط"),this.classList.add("invalid"),this.classList.remove("valid"))})})},window.setupMotherNINValidation=function(a){const t=document.getElementById(`mother_${a}_nin`);if(!t)return;let n=null;t.addEventListener("keypress",function(e){[8,9,27,13,46].indexOf(e.keyCode)!==-1||e.keyCode===65&&e.ctrlKey===!0||e.keyCode===67&&e.ctrlKey===!0||e.keyCode===86&&e.ctrlKey===!0||e.keyCode===88&&e.ctrlKey===!0||e.keyCode>=35&&e.keyCode<=39||((e.shiftKey||e.keyCode<48||e.keyCode>57)&&(e.keyCode<96||e.keyCode>105)&&e.preventDefault(),this.value.length>=18&&e.preventDefault())}),t.addEventListener("input",function(){this.value=this.value.replace(/\D/g,""),this.value.length>18&&(this.value=this.value.slice(0,18));const e=this.value.trim();if(n&&clearTimeout(n),e===""){c(this),this.classList.remove("valid","invalid");return}e.length===18?(n=setTimeout(async()=>{try{(await(await fetch("/api/check/mother/nin",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.content||""},body:JSON.stringify({nin:e})})).json()).exists?(f(t,"هذا الرقم الوطني موجود بالفعل"),t.classList.add("invalid"),t.classList.remove("valid")):(c(t),t.classList.add("valid"),t.classList.remove("invalid"))}catch(s){console.error("Error checking NIN:",s),c(t),t.classList.add("valid"),t.classList.remove("invalid")}},500),c(t),t.classList.remove("invalid")):(f(this,`الرقم الوطني يجب أن يحتوي على 18 رقمًا (${e.length}/18)`),this.classList.add("invalid"),this.classList.remove("valid"))}),t.addEventListener("blur",async function(){const e=this.value.trim();if(e===""){c(this),this.classList.remove("valid","invalid");return}if(e.length!==18)f(this,"الرقم الوطني يجب أن يحتوي على 18 رقمًا"),this.classList.add("invalid"),this.classList.remove("valid");else try{(await(await fetch("/api/check/mother/nin",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.content||""},body:JSON.stringify({nin:e})})).json()).exists?(f(this,"هذا الرقم الوطني موجود بالفعل"),this.classList.add("invalid"),this.classList.remove("valid")):(c(this),this.classList.add("valid"),this.classList.remove("invalid"))}catch(s){console.error("Error checking NIN:",s),c(this),this.classList.add("valid"),this.classList.remove("invalid")}})},window.setupMotherNSSValidation=function(a){const t=document.getElementById(`mother_${a}_nss`);if(!t)return;let n=null;t.addEventListener("keypress",function(e){[8,9,27,13,46].indexOf(e.keyCode)!==-1||e.keyCode===65&&e.ctrlKey===!0||e.keyCode===67&&e.ctrlKey===!0||e.keyCode===86&&e.ctrlKey===!0||e.keyCode===88&&e.ctrlKey===!0||e.keyCode>=35&&e.keyCode<=39||((e.shiftKey||e.keyCode<48||e.keyCode>57)&&(e.keyCode<96||e.keyCode>105)&&e.preventDefault(),this.value.length>=12&&e.preventDefault())}),t.addEventListener("paste",function(e){e.preventDefault();const r=(e.clipboardData||window.clipboardData).getData("text").replace(/\D/g,"").slice(0,12);this.value=r,this.dispatchEvent(new Event("input"))}),t.addEventListener("input",function(){this.value=this.value.replace(/\D/g,""),this.value.length>12&&(this.value=this.value.slice(0,12));const e=this.value.trim();if(n&&clearTimeout(n),e===""){c(this),this.classList.remove("valid","invalid");return}e.length===12?(n=setTimeout(async()=>{try{(await(await fetch("/api/check/mother/nss",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.content||""},body:JSON.stringify({nss:e})})).json()).exists?(f(t,"هذا رقم الضمان الاجتماعي موجود بالفعل"),t.classList.add("invalid"),t.classList.remove("valid")):(c(t),t.classList.add("valid"),t.classList.remove("invalid"))}catch(s){console.error("Error checking NSS:",s),c(t),t.classList.add("valid"),t.classList.remove("invalid")}},500),c(t),t.classList.remove("invalid")):(f(this,`رقم الضمان الاجتماعي يجب أن يحتوي على 12 رقمًا (${e.length}/12)`),this.classList.add("invalid"),this.classList.remove("valid"))}),t.addEventListener("blur",async function(){const e=this.value.trim();if(e===""){c(this),this.classList.remove("valid","invalid");return}if(e.length!==12)f(this,"رقم الضمان الاجتماعي يجب أن يحتوي على 12 رقمًا"),this.classList.add("invalid"),this.classList.remove("valid");else try{(await(await fetch("/api/check/mother/nss",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.content||""},body:JSON.stringify({nss:e})})).json()).exists?(f(this,"هذا رقم الضمان الاجتماعي موجود بالفعل"),this.classList.add("invalid"),this.classList.remove("valid")):(c(this),this.classList.add("valid"),this.classList.remove("invalid"))}catch(s){console.error("Error checking NSS:",s),c(this),this.classList.add("valid"),this.classList.remove("invalid")}})};function k(a,t=!0){if(a.disabled)return c(a),a.classList.remove("invalid","valid"),!0;const n=a.value.trim(),e=a.id,s=a.type,r=a.name;c(a);let i=!0,d="";if(s==="radio"){const b=document.querySelectorAll(`input[name="${r}"]`),C=document.querySelector(`input[name="${r}"]:checked`),w=a.closest(".form-group");if(w&&w.querySelectorAll(".error-message").forEach(l=>l.remove()),!C&&(i=!1,d="هذا الحقل مطلوب",t&&w)){const l=document.createElement("div");l.className="error-message",l.textContent=d,w.appendChild(l)}return b.forEach(l=>{l.classList.toggle("valid",i),l.classList.toggle("invalid",!i)}),i}if(a.tagName.toLowerCase()==="select"&&a.hasAttribute("required")&&(n===""||n==="none")&&(i=!1,d="هذا الحقل مطلوب"),a.hasAttribute("required")&&n===""&&(i=!1,d="هذا الحقل مطلوب"),i&&n!=="")switch(e){case"nin":/^\d{18}$/.test(n)||(i=!1,d="يجب أن يحتوي الرقم التعريفي الوطني على 18 رقمًا بالضبط");break;case"email":/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(n)||(i=!1,d="البريد الإلكتروني غير صالح");break;case"phone":/^\d{10}$/.test(n)||(i=!1,d="رقم الهاتف يجب أن يحتوي على 10 أرقام");break;case"password":/^(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&]).{8,}$/.test(n)||(i=!1,d="كلمة المرور ضعيفة، يجب أن تحتوي على حرف كبير، رقم، ورمز خاص");break;case"confirm_password":const b=document.getElementById("password").value;n!==b&&(i=!1,d="كلمة المرور غير مطابقة");break;case"date_naissance":const C=new Date;new Date(n)>C&&(i=!1,d="تاريخ الميلاد لا يمكن أن يكون في المستقبل");break;case"num_carte":/^\d{9}$/.test(n)||(i=!1,d="يجب أن يحتوي رقم بطاقة التعريف الوطنية على 9 أرقام");break;case"date_carte":const l=new Date;l.setHours(0,0,0,0),new Date(n)>l&&(i=!1,d="تاريخ إصدار البطاقة يجب أن يكون قبل أو يساوي تاريخ اليوم");break;case"nss":/^\d{12}$/.test(n)||(i=!1,d="رقم الضمان الاجتماعي يجب أن يحتوي على 12 رقمًا بالضبط");break;case"montant_s":if(document.getElementById("categorie_sociale").value!=="عديم الدخل"){const v=parseFloat(n);isNaN(v)||v<=0?(i=!1,d="يرجى إدخال مبلغ صالح (أكبر من 0)"):a.value=v}else a.value="0",i=!0,c(a);break;case"num_cp":/^\d{10}$/.test(n)||(i=!1,d="رقم الحساب البريدي يجب أن يحتوي على 10 أرقام");break;case"cle_ccp":/^\d{2}$/.test(n)||(i=!1,d="الرقم المفتاح يجب أن يحتوي على رقمين اثنين");break}return i?j(a):t?f(a,d):a.classList.remove("valid","invalid"),i}const N=document.getElementById("phone");N&&N.addEventListener("input",function(){const a=this.value.replace(/\D/g,"");this.value!==a?f(this,"يجب إدخال أرقام فقط"):a.length>0&&a.length!==10?f(this,"رقم الهاتف يجب أن يحتوي على 10 أرقام"):(c(this),this.classList.add("valid"),this.classList.remove("invalid")),this.value=a.slice(0,10)}),["nom_ar","prenom_ar"].forEach(a=>{const t=document.getElementById(a);if(!t)return;const n=/^[\u0600-\u06FF\s]+$/;t.addEventListener("keypress",function(e){const s=e.key;/^[\u0600-\u06FF\s]$/.test(s)||(e.preventDefault(),f(this,"يرجى الإدخال باللغة العربية فقط"),this.classList.add("invalid"),this.classList.remove("valid"))}),t.addEventListener("input",function(){const e=this.value.trim();if(e===""){c(this),this.classList.remove("valid","invalid");return}n.test(e)?(c(this),this.classList.add("valid"),this.classList.remove("invalid")):(f(this,"يرجى الإدخال باللغة العربية فقط"),this.classList.add("invalid"),this.classList.remove("valid"))})}),["nom_fr","prenom_fr"].forEach(a=>{const t=document.getElementById(a);if(!t)return;const n=/^[A-Za-zÀ-ÿ\s]+$/;t.addEventListener("keypress",function(e){const s=e.key;/^[\u0600-\u06FF]$/.test(s)&&(e.preventDefault(),f(this,"يرجى الإدخال بالحروف اللاتينية فقط"),this.classList.add("invalid"),this.classList.remove("valid"))}),t.addEventListener("input",function(){const e=this.value.trim();if(e===""){c(this),this.classList.remove("valid","invalid");return}n.test(e)?(c(this),this.classList.add("valid"),this.classList.remove("invalid")):(f(this,"يرجى الإدخال بالحروف اللاتينية فقط"),this.classList.add("invalid"),this.classList.remove("valid"))})});function T(){const a=document.querySelectorAll(".form-step.active input, .form-step.active select"),t=document.getElementById("categorie_sociale"),n=document.getElementById("montant_s"),e=document.getElementById("montant_s_wrapper");t&&n&&e&&(t._changeHandler&&t.removeEventListener("change",t._changeHandler),t._changeHandler=function(){this.value==="الدخل الشهري أقل أو يساوي مبلغ الأجر الوطني الأدنى المضمون"?(e.style.display="block",n.removeAttribute("disabled"),n.setAttribute("required","required"),n.value=""):(e.style.display="none",n.value="",n.removeAttribute("required"),n.removeAttribute("disabled"),n.classList.remove("valid","invalid"),c(n))},t.addEventListener("change",t._changeHandler),t._changeHandler()),a.forEach(s=>{s.removeEventListener("input",s._inputHandler),s.removeEventListener("blur",s._blurHandler),s.id==="nin"&&s.addEventListener("input",()=>{s.value=s.value.replace(/\D/g,"").slice(0,18)}),s.id==="num_carte"&&s.addEventListener("input",()=>{s.value=s.value.replace(/\D/g,"").slice(0,9)}),s.id==="nss"&&s.addEventListener("input",()=>{s.value=s.value.replace(/\D/g,"").slice(0,12)}),s.id==="montant_s"&&s.addEventListener("input",()=>{parseFloat(s.value)<0&&(s.value="")}),s.id==="num_cp"&&s.addEventListener("input",()=>{s.value=s.value.replace(/\D/g,"").slice(0,10)}),s.id==="cle_ccp"&&s.addEventListener("input",()=>{s.value=s.value.replace(/\D/g,"").slice(0,2)}),s._inputHandler=()=>{s.value.trim()!==""&&k(s,!1)},s.addEventListener("input",s._inputHandler),s._blurHandler=()=>{s.value.trim()!==""&&k(s,!0)},s.addEventListener("blur",s._blurHandler)})}function V(){const a=document.getElementById("categorie_sociale"),t=document.getElementById("montant_s"),n=document.getElementById("montant_s_wrapper");a&&t&&n&&(a.value==="عديم الدخل"||a.value===""?(n.style.display="none",t.value="",t.removeAttribute("required"),c(t)):a.value==="الدخل الشهري أقل أو يساوي مبلغ الأجر الوطني الأدنى المضمون"&&(n.style.display="block",t.removeAttribute("disabled"),t.setAttribute("required","required"),t.value==="0"&&(t.value="")))}function R(){const a=document.querySelector(".form-step.active"),t=a.querySelectorAll("input[required], select[required]");let n=!0,e=[];return a.querySelectorAll(".error-message").forEach(s=>s.remove()),t.forEach(s=>{const r=s.closest("#montant_s_wrapper");if(!(r&&window.getComputedStyle(r).display==="none")&&!k(s,!0)){n=!1;const i=s.closest(".form-group")?.querySelector("label")?.textContent||s.name;e.push(i)}}),t.forEach(s=>{if(!(s.disabled&&s.id!=="montant_s")&&!k(s,!0)){n=!1;const r=s.closest(".form-group")?.querySelector("label")?.textContent||s.name;e.includes(r)||e.push(r)}}),!n&&typeof Swal<"u"&&Swal.fire({icon:"warning",title:"يرجى إكمال البيانات",html:`الحقول التالية مطلوبة أو تحتوي على أخطاء:<br><b>${e.join("<br>")}</b>`,confirmButtonText:"حسنًا"}),n}F.forEach(a=>{a.addEventListener("click",()=>{(L===0||L===1)&&!R()||L<A.length-1&&(L++,q())})}),H.forEach(a=>{a.addEventListener("click",()=>{L>0&&(L--,q())})});const S=document.getElementById("signupForm");function K(a,t){if(a=a.trim(),t=t.trim(),!/^\d+$/.test(a)||!/^\d+$/.test(t))return!1;const e=parseInt(a,10)*100%97,r=(97-(e+85>97?e+85-97:e+85)).toString().padStart(2,"0");return t===r}S&&(S.noValidate=!0,S.addEventListener("submit",async a=>{a.preventDefault();let t=!0,n=[];document.querySelectorAll(".error-message").forEach(l=>l.remove()),S.querySelectorAll("input[required], select[required]").forEach(l=>{if(!k(l,!0)){t=!1;const E=l.closest(".form-group, .col-md-3")?.querySelector("label")?.textContent||l.name;n.includes(E)||n.push(E)}});const s=S.querySelector('input[name="gender"]:checked');s||(t=!1,n.includes("الجنس")||n.push("الجنس"));const r=document.getElementById("agreement_checkbox");if(!r||!r.checked?(t=!1,n.includes("الموافقة على القوانين")||n.push("الموافقة على القوانين"),r&&(r.style.outline="2px solid #ef4444",r.style.outlineOffset="2px")):r&&(r.style.outline="",r.style.outlineOffset=""),!t){Swal.fire({icon:"warning",title:"يرجى إكمال البيانات",html:`الحقول التالية مطلوبة أو تحتوي على أخطاء:<br><b>${n.join("<br>")}</b>`,confirmButtonText:"حسنًا"});return}const i=Object.fromEntries(new FormData(S).entries()),d={nin:i.nin,email:i.email,tel:i.phone,password:i.password,nom_ar:i.nom_ar,prenom_ar:i.prenom_ar,nom_fr:i.nom_fr,prenom_fr:i.prenom_fr,sexe:s.value==="male"?"ذكر":"أنثى",date_naiss:i.date_naissance,presume:i.presume?"1":"0",commune_naiss:document.getElementById("communeSelectSignup")?.value||null,adresse:i.adresse,nbr_enfants_scolarise:i.nbr_enfants,num_cni:i.num_carte,date_cni:i.date_carte,lieu_cni:document.getElementById("commune_carte")?.value||null,nss:i.nss,num_cpt:i.num_cp,cle_cpt:i.cle_ccp,cats:i.categorie_sociale,montant_s:i.categorie_sociale==="الدخل الشهري أقل أو يساوي مبلغ الأجر الوطني الأدنى المضمون"&&i.montant_s||null,autr_info:i.autre_info||"",code_commune:document.getElementById("communeSelectSignup")?.value||null},b=[];if(document.querySelectorAll(".mother-fields").forEach((l,E)=>{const g=l.dataset.motherIndex,v={nin:i[`mother_${g}_nin`],nss:i[`mother_${g}_nss`],nom_ar:i[`mother_${g}_nom_ar`],prenom_ar:i[`mother_${g}_prenom_ar`],categorie_sociale:i[`mother_${g}_categorie_sociale`],montant_s:i[`mother_${g}_montant_s`]||null};v.nin&&v.nss&&v.nom_ar&&v.prenom_ar&&v.categorie_sociale&&(v.nin=String(v.nin).replace(/\D/g,"").slice(0,18),v.nss=String(v.nss).replace(/\D/g,"").slice(0,12),v.nin.length===18&&v.nss.length===12?b.push(v):console.warn(`Mother ${g} data invalid: NIN length=${v.nin.length}, NSS length=${v.nss.length}`))}),b.length>0&&(d.mothers=b),!K(d.num_cpt,d.cle_cpt)){Swal.fire({icon:"warning",title:" CCP خطأ في",text:"رقم CCP أو مفتاح CCP غير صحيح. يرجى التحقق.",confirmButtonText:"حسنًا"});return}const w=new FormData;for(const l in d)d[l]!==void 0&&d[l]!==null&&(l==="mothers"&&Array.isArray(d[l])?w.append(l,JSON.stringify(d[l])):w.append(l,d[l]));try{Swal.fire({title:"جاري الإرسال...",text:"الرجاء الانتظار قليلاً",allowOutsideClick:!1,didOpen:()=>Swal.showLoading()});const l=await fetch("/api/tuteurs",{method:"POST",body:w,headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content,Accept:"application/json"}}),E=await l.json();if(Swal.close(),l.status===422){const g=Object.values(E.errors||{}).flat().join("<br>");Swal.fire({icon:"warning",title:"تحقق من البيانات",html:g,confirmButtonText:"حسنًا",customClass:{confirmButton:"swal-confirm-btn"},buttonsStyling:!1});return}if(!l.ok){Swal.fire({icon:"error",title:"حدث خطأ أثناء التسجيل",text:E.message||"يرجى المحاولة لاحقًا.",confirmButtonText:"حسنًا",customClass:{confirmButton:"swal-confirm-btn"},buttonsStyling:!1});return}Swal.fire({icon:"success",title:"✅ تم التسجيل بنجاح!",text:"يمكنك الآن تسجيل الدخول إلى حسابك.",confirmButtonText:"حسنًا",customClass:{confirmButton:"swal-confirm-btn"},buttonsStyling:!1}).then(()=>{window.location.href="/login"})}catch(l){console.error("❌ Fetch error:",l),Swal.close(),Swal.fire({icon:"error",title:"خطأ في الاتصال بالخادم",text:"تحقق من الاتصال بالخادم المحلي أو الشبكة."})}})),W(),T(),q()});document.querySelectorAll(".toggle-password").forEach(u=>{u.addEventListener("click",()=>{const o=u.closest(".password-wrapper").querySelector("input");o.type==="password"?(o.type="text",u.classList.replace("fa-eye","fa-eye-slash")):(o.type="password",u.classList.replace("fa-eye-slash","fa-eye"))})});
