function I(){document.querySelectorAll("#signupForm .form-group").forEach(d=>{const c=d.querySelector("input[required], select[required], textarea[required]"),v=d.querySelector("label");if(c&&!c.disabled&&v&&!v.querySelector(".text-danger")){const u=document.createElement("span");u.className="text-danger",u.textContent=" *",v.appendChild(u)}})}document.addEventListener("DOMContentLoaded",()=>{const d=document.getElementById("wilayaSelectSignup"),c=document.getElementById("communeSelectSignup");if(d&&c){async function t(){try{d.innerHTML='<option value="">جارٍ التحميل...</option>';const e=await(await fetch("/api/wilayas")).json(),n=Array.isArray(e)?e:e.data||[];d.innerHTML='<option value="">اختر...</option>',Array.isArray(n)&&n.forEach(r=>{d.innerHTML+=`<option value="${r.code_wil}">${r.lib_wil_ar}</option>`})}catch(a){console.error("خطأ في تحميل الولايات:",a),d.innerHTML='<option value="">تعذر تحميل البيانات</option>'}}async function s(a){try{c.innerHTML='<option value="">جارٍ التحميل...</option>',c.disabled=!0;const n=await(await fetch(`/api/communes/by-wilaya/${a}`)).json(),r=Array.isArray(n)?n:n.data||[];c.innerHTML='<option value="">اختر...</option>',Array.isArray(r)&&r.forEach(o=>{c.innerHTML+=`<option value="${o.code_comm}">${o.lib_comm_ar}</option>`}),c.disabled=!1}catch(e){console.error("خطأ في تحميل البلديات:",e),c.innerHTML='<option value="">تعذر تحميل البيانات</option>'}}d.addEventListener("change",a=>{const e=a.target.value;e?s(e):(c.innerHTML='<option value="">اختر الولاية أولا...</option>',c.disabled=!0)}),t()}const v=document.getElementById("wilaya_carte"),u=document.getElementById("commune_carte");if(v&&u){async function t(){try{v.innerHTML='<option value="">جارٍ التحميل...</option>';const e=await(await fetch("/api/wilayas")).json(),n=Array.isArray(e)?e:e.data||[];v.innerHTML='<option value="">-- اختر الولاية --</option>',Array.isArray(n)&&n.forEach(r=>v.innerHTML+=`<option value="${r.code_wil}">${r.lib_wil_ar}</option>`)}catch(a){console.error("خطأ في تحميل ولايات البطاقة:",a),v.innerHTML='<option value="">تعذر تحميل البيانات</option>'}}async function s(a){try{u.innerHTML='<option value="">جارٍ التحميل...</option>',u.disabled=!0;const n=await(await fetch(`/api/communes/by-wilaya/${a}`)).json(),r=Array.isArray(n)?n:n.data||[];u.innerHTML='<option value="">-- اختر البلدية --</option>',Array.isArray(r)&&r.forEach(o=>u.innerHTML+=`<option value="${o.code_comm}">${o.lib_comm_ar}</option>`),u.disabled=!1}catch(e){console.error("خطأ في تحميل بلديات البطاقة:",e),u.innerHTML='<option value="">تعذر تحميل البيانات</option>'}}v.addEventListener("change",a=>{const e=a.target.value;e?s(e):(u.innerHTML='<option value="">اختر الولاية أولا...</option>',u.disabled=!0)}),t()}I();const E=document.querySelectorAll(".form-step"),C=document.querySelectorAll(".next-step"),x=document.querySelectorAll(".prev-step"),B=document.getElementById("progress"),S=document.querySelectorAll(".progress-step");let p=0;function w(){E.forEach((t,s)=>t.classList.toggle("active",s===p)),S.forEach((t,s)=>t.classList.toggle("active",s<=p)),B.style.width=p/(S.length-1)*100+"%",q(),$()}function y(t,s){if(m(t),!s)return;const a=document.createElement("div");a.className="error-message",a.textContent=s,(t.closest(".password-wrapper")||t).insertAdjacentElement("afterend",a),t.classList.add("invalid"),t.classList.remove("valid")}function H(t){m(t),t.classList.add("valid"),t.classList.remove("invalid")}function m(t){(t.closest(".password-wrapper")||t).parentNode.querySelectorAll(".error-message").forEach(e=>e.remove())}function _(t,s=!0){if(t.disabled)return m(t),t.classList.remove("invalid","valid"),!0;const a=t.value.trim(),e=t.id,n=t.type,r=t.name;m(t);let o=!0,i="";if(n==="radio"){const l=document.querySelectorAll(`input[name="${r}"]`),h=document.querySelector(`input[name="${r}"]:checked`),g=t.closest(".form-group");if(g&&g.querySelectorAll(".error-message").forEach(f=>f.remove()),!h&&(o=!1,i="هذا الحقل مطلوب",s&&g)){const f=document.createElement("div");f.className="error-message",f.textContent=i,g.appendChild(f)}return l.forEach(f=>{f.classList.toggle("valid",o),f.classList.toggle("invalid",!o)}),o}if(t.tagName.toLowerCase()==="select"&&t.hasAttribute("required")&&(a===""||a==="none")&&(o=!1,i="هذا الحقل مطلوب"),t.hasAttribute("required")&&a===""&&(o=!1,i="هذا الحقل مطلوب"),o&&a!=="")switch(e){case"nin":/^\d{18}$/.test(a)||(o=!1,i="يجب أن يحتوي الرقم التعريفي الوطني على 18 رقمًا بالضبط");break;case"email":/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a)||(o=!1,i="البريد الإلكتروني غير صالح");break;case"phone":/^\d{10}$/.test(a)||(o=!1,i="رقم الهاتف يجب أن يحتوي على 10 أرقام");break;case"password":/^(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&]).{8,}$/.test(a)||(o=!1,i="كلمة المرور ضعيفة، يجب أن تحتوي على حرف كبير، رقم، ورمز خاص");break;case"confirm_password":const l=document.getElementById("password").value;a!==l&&(o=!1,i="كلمة المرور غير مطابقة");break;case"date_naissance":const h=new Date;new Date(a)>h&&(o=!1,i="تاريخ الميلاد لا يمكن أن يكون في المستقبل");break;case"num_carte":/^\d{9}$/.test(a)||(o=!1,i="يجب أن يحتوي رقم بطاقة التعريف الوطنية على 9 أرقام");break;case"date_carte":const f=new Date;f.setHours(0,0,0,0),new Date(a)>f&&(o=!1,i="تاريخ إصدار البطاقة يجب أن يكون قبل أو يساوي تاريخ اليوم");break;case"nss":/^\d{12}$/.test(a)||(o=!1,i="الرقم الوطني للضمان الاجتماعي يجب أن يحتوي على 12 رقمًا بالضبط");break;case"montant_s":if(document.getElementById("categorie_sociale").value!=="عديم الدخل"){const L=parseFloat(a);isNaN(L)||L<=0?(o=!1,i="يرجى إدخال مبلغ صالح (أكبر من 0)"):t.value=L}else t.value="0",o=!0,m(t);break;case"num_cp":/^\d{10}$/.test(a)||(o=!1,i="رقم الحساب البريدي يجب أن يحتوي على 10 أرقام");break;case"cle_ccp":/^\d{2}$/.test(a)||(o=!1,i="الرقم المفتاح يجب أن يحتوي على رقمين اثنين");break}return o?H(t):s?y(t,i):t.classList.remove("valid","invalid"),o}const A=document.getElementById("phone");A&&A.addEventListener("input",function(){const t=this.value.replace(/\D/g,"");this.value!==t?y(this,"يجب إدخال أرقام فقط"):t.length>0&&t.length!==10?y(this,"رقم الهاتف يجب أن يحتوي على 10 أرقام"):(m(this),this.classList.add("valid"),this.classList.remove("invalid")),this.value=t.slice(0,10)}),["nom_ar","prenom_ar"].forEach(t=>{const s=document.getElementById(t);if(!s)return;const a=/^[\u0600-\u06FF\s]+$/;s.addEventListener("keypress",function(e){const n=e.key;/^[\u0600-\u06FF\s]$/.test(n)||(e.preventDefault(),y(this,"يرجى الإدخال باللغة العربية فقط"),this.classList.add("invalid"),this.classList.remove("valid"))}),s.addEventListener("input",function(){const e=this.value.trim();if(e===""){m(this),this.classList.remove("valid","invalid");return}a.test(e)?(m(this),this.classList.add("valid"),this.classList.remove("invalid")):(y(this,"يرجى الإدخال باللغة العربية فقط"),this.classList.add("invalid"),this.classList.remove("valid"))})}),["nom_fr","prenom_fr"].forEach(t=>{const s=document.getElementById(t);if(!s)return;const a=/^[A-Za-zÀ-ÿ\s]+$/;s.addEventListener("keypress",function(e){const n=e.key;/^[\u0600-\u06FF]$/.test(n)&&(e.preventDefault(),y(this,"يرجى الإدخال بالحروف اللاتينية فقط"),this.classList.add("invalid"),this.classList.remove("valid"))}),s.addEventListener("input",function(){const e=this.value.trim();if(e===""){m(this),this.classList.remove("valid","invalid");return}a.test(e)?(m(this),this.classList.add("valid"),this.classList.remove("invalid")):(y(this,"يرجى الإدخال بالحروف اللاتينية فقط"),this.classList.add("invalid"),this.classList.remove("valid"))})});function q(){const t=document.querySelectorAll(".form-step.active input, .form-step.active select"),s=document.getElementById("categorie_sociale"),a=document.getElementById("montant_s");s&&a&&(s.removeEventListener("change",s._changeHandler),s._changeHandler=function(){this.value==="1"?(a.removeAttribute("disabled"),a.setAttribute("required","required"),a.value=""):(a.value="0",a.setAttribute("disabled","disabled"),a.removeAttribute("required"),a.classList.remove("valid","invalid"),m(a))},s.addEventListener("change",s._changeHandler),s._changeHandler()),t.forEach(e=>{e.removeEventListener("input",e._inputHandler),e.removeEventListener("blur",e._blurHandler),e.id==="nin"&&e.addEventListener("input",()=>{e.value=e.value.replace(/\D/g,"").slice(0,18)}),e.id==="num_carte"&&e.addEventListener("input",()=>{e.value=e.value.replace(/\D/g,"").slice(0,9)}),e.id==="nss"&&e.addEventListener("input",()=>{e.value=e.value.replace(/\D/g,"").slice(0,12)}),e.id==="montant_s"&&e.addEventListener("input",()=>{parseFloat(e.value)<0&&(e.value="")}),e.id==="num_cp"&&e.addEventListener("input",()=>{e.value=e.value.replace(/\D/g,"").slice(0,10)}),e.id==="cle_ccp"&&e.addEventListener("input",()=>{e.value=e.value.replace(/\D/g,"").slice(0,2)}),e._inputHandler=()=>{e.value.trim()!==""&&_(e,!1)},e.addEventListener("input",e._inputHandler),e._blurHandler=()=>{e.value.trim()!==""&&_(e,!0)},e.addEventListener("blur",e._blurHandler)})}function $(){const t=document.getElementById("categorie_sociale"),s=document.getElementById("montant_s");t.value==="2"||t.value===""?(s.value="0",s.setAttribute("disabled",!0),s.removeAttribute("required"),m(s)):(s.removeAttribute("disabled"),s.setAttribute("required","required"),s.value==="0"&&(s.value=""))}function k(){const t=document.querySelector(".form-step.active"),s=t.querySelectorAll("input[required], select[required]");let a=!0,e=[];return t.querySelectorAll(".error-message").forEach(n=>n.remove()),s.forEach(n=>{if(!_(n,!0)){a=!1;const r=n.closest(".form-group")?.querySelector("label")?.textContent||n.name;e.push(r)}}),s.forEach(n=>{if(!(n.disabled&&n.id!=="montant_s")&&!_(n,!0)){a=!1;const r=n.closest(".form-group")?.querySelector("label")?.textContent||n.name;e.includes(r)||e.push(r)}}),!a&&typeof Swal<"u"&&Swal.fire({icon:"warning",title:"يرجى إكمال البيانات",html:`الحقول التالية مطلوبة أو تحتوي على أخطاء:<br><b>${e.join("<br>")}</b>`,confirmButtonText:"حسنًا"}),a}C.forEach(t=>{t.addEventListener("click",()=>{(p===0||p===1)&&!k()||p<E.length-1&&(p++,w())})}),x.forEach(t=>{t.addEventListener("click",()=>{p>0&&(p--,w())})});const b=document.getElementById("signupForm");function D(t,s){if(t=t.trim(),s=s.trim(),!/^\d+$/.test(t)||!/^\d+$/.test(s))return!1;const e=parseInt(t,10)*100%97,r=(97-(e+85>97?e+85-97:e+85)).toString().padStart(2,"0");return s===r}b&&(b.noValidate=!0,b.addEventListener("submit",async t=>{t.preventDefault();let s=!0,a=[];document.querySelectorAll(".error-message").forEach(l=>l.remove()),b.querySelectorAll("input[required], select[required]").forEach(l=>{if(!_(l,!0)){s=!1;const h=l.closest(".form-group, .col-md-3")?.querySelector("label")?.textContent||l.name;a.includes(h)||a.push(h)}});const n=b.querySelector('input[name="gender"]:checked');if(n||(s=!1,a.includes("الجنس")||a.push("الجنس")),!s){Swal.fire({icon:"warning",title:"يرجى إكمال البيانات",html:`الحقول التالية مطلوبة أو تحتوي على أخطاء:<br><b>${a.join("<br>")}</b>`,confirmButtonText:"حسنًا"});return}const r=Object.fromEntries(new FormData(b).entries()),o={nin:r.nin,email:r.email,tel:r.phone,password:r.password,nom_ar:r.nom_ar,prenom_ar:r.prenom_ar,nom_fr:r.nom_fr,prenom_fr:r.prenom_fr,sexe:n.value==="male"?"ذكر":"أنثى",date_naiss:r.date_naissance,presume:r.presume?"1":"0",commune_naiss:document.getElementById("communeSelectSignup")?.value||null,adresse:r.adresse,nbr_enfants_scolarise:r.nbr_enfants,num_cni:r.num_carte,date_cni:r.date_carte,lieu_cni:document.getElementById("commune_carte")?.value||null,nss:r.nss,num_cpt:r.num_cp,cle_cpt:r.cle_ccp,cats:r.categorie_sociale,montant_s:r.montant_s,autr_info:r.autre_info||"",code_commune:document.getElementById("communeSelectSignup")?.value||null};if(!D(o.num_cpt,o.cle_cpt)){Swal.fire({icon:"warning",title:" CCP خطأ في",text:"رقم CCP أو مفتاح CCP غير صحيح. يرجى التحقق.",confirmButtonText:"حسنًا"});return}const i=new FormData;for(const l in o)o[l]!==void 0&&o[l]!==null&&i.append(l,o[l]);try{Swal.fire({title:"جاري الإرسال...",text:"الرجاء الانتظار قليلاً",allowOutsideClick:!1,didOpen:()=>Swal.showLoading()});const l=await fetch("/api/tuteurs",{method:"POST",body:i,headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content,Accept:"application/json"}}),h=await l.json();if(Swal.close(),l.status===422){const g=Object.values(h.errors||{}).flat().join("<br>");Swal.fire({icon:"warning",title:"تحقق من البيانات",html:g,confirmButtonText:"حسنًا",customClass:{confirmButton:"swal-confirm-btn"},buttonsStyling:!1});return}if(!l.ok){Swal.fire({icon:"error",title:"حدث خطأ أثناء التسجيل",text:h.message||"يرجى المحاولة لاحقًا.",confirmButtonText:"حسنًا",customClass:{confirmButton:"swal-confirm-btn"},buttonsStyling:!1});return}Swal.fire({icon:"success",title:"✅ تم التسجيل بنجاح!",text:"يمكنك الآن تسجيل الدخول إلى حسابك.",confirmButtonText:"حسنًا",customClass:{confirmButton:"swal-confirm-btn"},buttonsStyling:!1}).then(()=>{window.location.href="/login"})}catch(l){console.error("❌ Fetch error:",l),Swal.close(),Swal.fire({icon:"error",title:"خطأ في الاتصال بالخادم",text:"تحقق من الاتصال بالخادم المحلي أو الشبكة."})}})),q(),w()});document.querySelectorAll(".toggle-password").forEach(d=>{d.addEventListener("click",()=>{const c=d.closest(".password-wrapper").querySelector("input");c.type==="password"?(c.type="text",d.classList.replace("fa-eye","fa-eye-slash")):(c.type="password",d.classList.replace("fa-eye-slash","fa-eye"))})});
