function B(){document.querySelectorAll("#signupForm .form-group").forEach(o=>{const i=o.querySelector("input[required], select[required], textarea[required]"),u=o.querySelector("label");if(i&&!i.disabled&&u&&!u.querySelector(".text-danger")){const d=document.createElement("span");d.className="text-danger",d.textContent=" *",u.appendChild(d)}})}const X=new Date("2026-03-01T00:00:00");function Y(){const o=document.getElementById("signupForm"),i=document.getElementById("deadlineAlert");if(!o)return;const d=new Date>=X;i&&i.classList.toggle("d-none",!d),d&&o.querySelectorAll("input, select, textarea, button").forEach(p=>{p.type!=="hidden"&&(p.disabled=!0)})}function M(){return`
        <div class="father-fields" style="border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 5px; background-color: #f9f9f9;">
            <div class="form-row">
                <div class="form-group">
                    <label for="father_nin">الرقم الوطني للأب (NIN) <span class="text-danger">*</span></label>
                    <input type="text" id="father_nin" name="father_nin" required maxlength="18" inputmode="numeric" pattern="[0-9]{18}">
                </div>
                <div class="form-group">
                    <label for="father_nss">رقم الضمان الاجتماعي للأب (NSS) <span class="text-danger">*</span></label>
                    <input type="text" id="father_nss" name="father_nss" required maxlength="12" inputmode="numeric" pattern="[0-9]{12}">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="father_nom_ar">لقب الأب بالعربية <span class="text-danger">*</span></label>
                    <input type="text" id="father_nom_ar" name="father_nom_ar" required>
                </div>
                <div class="form-group">
                    <label for="father_prenom_ar">اسم الأب بالعربية <span class="text-danger">*</span></label>
                    <input type="text" id="father_prenom_ar" name="father_prenom_ar" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="father_nom_fr">لقب الأب باللاتينية</label>
                    <input type="text" id="father_nom_fr" name="father_nom_fr">
                </div>
                <div class="form-group">
                    <label for="father_prenom_fr">اسم الأب باللاتينية</label>
                    <input type="text" id="father_prenom_fr" name="father_prenom_fr">
                </div>
            </div>
            
            <div class="form-group">
                <label for="father_categorie_sociale">الفئة الاجتماعية <span class="text-danger">*</span></label>
                <select id="father_categorie_sociale" name="father_categorie_sociale" required>
                    <option value="" disabled selected>اختر الفئة الاجتماعية</option>
                    <option value="عديم الدخل">عديم الدخل</option>
                    <option value="الدخل الشهري أقل أو يساوي مبلغ الأجر الوطني الأدنى المضمون">الدخل الشهري أقل أو يساوي مبلغ الأجر الوطني الأدنى المضمون</option>
                </select>
            </div>
            
            <div class="form-group" id="father_montant_wrapper" style="display: none;">
                <label for="father_montant_s">مبلغ الدخل الشهري <span class="text-danger">*</span></label>
                <input type="number" id="father_montant_s" name="father_montant_s" min="0" step="0.01">
            </div>
        </div>
    `}function z(){return`
        <div class="mother-fields-simple" style="border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 5px; background-color: #f9f9f9;">
            <div class="form-row">
                <div class="form-group">
                    <label for="mother_simple_nin">الرقم الوطني للأم (NIN) <span class="text-danger">*</span></label>
                    <input type="text" id="mother_simple_nin" name="mother_simple_nin" required maxlength="18" inputmode="numeric" pattern="[0-9]{18}">
                </div>
                <div class="form-group">
                    <label for="mother_simple_nss">رقم الضمان الاجتماعي للأم (NSS) <span class="text-danger">*</span></label>
                    <input type="text" id="mother_simple_nss" name="mother_simple_nss" required maxlength="12" inputmode="numeric" pattern="[0-9]{12}">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="mother_simple_nom_ar">لقب الأم بالعربية <span class="text-danger">*</span></label>
                    <input type="text" id="mother_simple_nom_ar" name="mother_simple_nom_ar" required>
                </div>
                <div class="form-group">
                    <label for="mother_simple_prenom_ar">اسم الأم بالعربية <span class="text-danger">*</span></label>
                    <input type="text" id="mother_simple_prenom_ar" name="mother_simple_prenom_ar" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="mother_simple_nom_fr">لقب الأم باللاتينية</label>
                    <input type="text" id="mother_simple_nom_fr" name="mother_simple_nom_fr">
                </div>
                <div class="form-group">
                    <label for="mother_simple_prenom_fr">اسم الأم باللاتينية</label>
                    <input type="text" id="mother_simple_prenom_fr" name="mother_simple_prenom_fr">
                </div>
            </div>
            
            <div class="form-group">
                <label for="mother_simple_categorie_sociale">الفئة الاجتماعية <span class="text-danger">*</span></label>
                <select id="mother_simple_categorie_sociale" name="mother_simple_categorie_sociale" required>
                    <option value="" disabled selected>اختر الفئة الاجتماعية</option>
                    <option value="عديم الدخل">عديم الدخل</option>
                    <option value="الدخل الشهري أقل أو يساوي مبلغ الأجر الوطني الأدنى المضمون">الدخل الشهري أقل أو يساوي مبلغ الأجر الوطني الأدنى المضمون</option>
                </select>
            </div>
            
            <div class="form-group" id="mother_simple_montant_wrapper" style="display: none;">
                <label for="mother_simple_montant_s">مبلغ الدخل الشهري <span class="text-danger">*</span></label>
                <input type="number" id="mother_simple_montant_s" name="mother_simple_montant_s" min="0" step="0.01">
            </div>
        </div>
    `}let L=0;function H(o){const i=`mother_${o}`;return`
        <div class="mother-fields" data-mother-index="${o}" style="border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 5px; background-color: #f9f9f9;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h4 style="margin: 0; font-size: 1rem; color: #555;">معلومات الزوجة ${o>0?o:""}</h4>
                ${o>0?'<button type="button" class="remove-mother-btn" style="background-color: #dc3545; color: white; border: none; padding: 0.3rem 0.8rem; border-radius: 3px; cursor: pointer;">حذف</button>':""}
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="${i}_nin">الرقم الوطني للأم (NIN) <span class="text-danger">*</span></label>
                    <input type="text" id="${i}_nin" name="${i}_nin" required maxlength="18" inputmode="numeric" pattern="[0-9]{18}">
                </div>
                <div class="form-group">
                    <label for="${i}_nss">رقم الضمان الاجتماعي للأم (NSS) <span class="text-danger">*</span></label>
                    <input type="text" id="${i}_nss" name="${i}_nss" required maxlength="12" inputmode="numeric" pattern="[0-9]{12}">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="${i}_nom_ar">لقب الأم بالعربية <span class="text-danger">*</span></label>
                    <input type="text" id="${i}_nom_ar" name="${i}_nom_ar" required>
                </div>
                <div class="form-group">
                    <label for="${i}_prenom_ar">اسم الأم بالعربية <span class="text-danger">*</span></label>
                    <input type="text" id="${i}_prenom_ar" name="${i}_prenom_ar" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="${i}_nom_fr">لقب الأم باللاتينية</label>
                    <input type="text" id="${i}_nom_fr" name="${i}_nom_fr">
                </div>
                <div class="form-group">
                    <label for="${i}_prenom_fr">اسم الأم باللاتينية</label>
                    <input type="text" id="${i}_prenom_fr" name="${i}_prenom_fr">
                </div>
            </div>
            
            <div class="form-group">
                <label for="${i}_categorie_sociale">الفئة الاجتماعية <span class="text-danger">*</span></label>
                <select id="${i}_categorie_sociale" name="${i}_categorie_sociale" required>
                    <option value="" disabled selected>اختر الفئة الاجتماعية</option>
                    <option value="عديم الدخل">عديم الدخل</option>
                    <option value="الدخل الشهري أقل أو يساوي مبلغ الأجر الوطني الأدنى المضمون">الدخل الشهري أقل أو يساوي مبلغ الأجر الوطني الأدنى المضمون</option>
                </select>
            </div>
            
            <div class="form-group" id="${i}_montant_wrapper" style="display: none;">
                <label for="${i}_montant_s">مبلغ الدخل الشهري <span class="text-danger">*</span></label>
                <input type="number" id="${i}_montant_s" name="${i}_montant_s">
            </div>
        </div>
    `}function Z(){L++;const o=document.getElementById("mothers-container");if(!o)return;const i=H(L);o.insertAdjacentHTML("beforeend",i);const u=o.querySelector(`[data-mother-index="${L}"] .remove-mother-btn`);u&&u.addEventListener("click",function(){this.closest(".mother-fields").remove()});const d=document.getElementById(`mother_${L}_categorie_sociale`),p=document.getElementById(`mother_${L}_montant_wrapper`),m=document.getElementById(`mother_${L}_montant_s`);d&&p&&m&&d.addEventListener("change",function(){this.value==="الدخل الشهري أقل أو يساوي مبلغ الأجر الوطني الأدنى المضمون"?(p.style.display="block",m.required=!0):(p.style.display="none",m.required=!1,m.value="")}),window.setupMotherArabicValidation&&window.setupMotherArabicValidation(L),window.setupMotherNINValidation&&window.setupMotherNINValidation(L),window.setupMotherNSSValidation&&window.setupMotherNSSValidation(L),B()}function G(o){const i=document.getElementById(`mother_${o}_categorie_sociale`),u=document.getElementById(`mother_${o}_montant_wrapper`),d=document.getElementById(`mother_${o}_montant_s`);i&&u&&d&&i.addEventListener("change",function(){this.value==="الدخل الشهري أقل أو يساوي مبلغ الأجر الوطني الأدنى المضمون"?(u.style.display="block",d.required=!0):(u.style.display="none",d.required=!1,d.value="")}),window.setupMotherArabicValidation&&window.setupMotherArabicValidation(o),window.setupMotherNINValidation&&window.setupMotherNINValidation(o),window.setupMotherNSSValidation&&window.setupMotherNSSValidation(o)}function Q(o){const i=document.getElementById("mothers-section"),u=document.getElementById("father-section"),d=document.getElementById("mother-section"),p=document.getElementById("mothers-container"),m=document.getElementById("father-container"),S=document.getElementById("mother-container");i&&(i.style.display="none"),u&&(u.style.display="none"),d&&(d.style.display="none"),p&&(p.innerHTML=""),m&&(m.innerHTML=""),S&&(S.innerHTML=""),o==="1"?(i&&(i.style.display="block"),p&&(L=0,p.innerHTML=H(0),G(0))):o==="2"?(u&&(u.style.display="block"),m&&(m.innerHTML=M(),F())):o==="3"&&(u&&(u.style.display="block"),d&&(d.style.display="block"),m&&(m.innerHTML=M(),F()),S&&(S.innerHTML=z(),U())),B()}function F(){const o=document.getElementById("father_nin"),i=document.getElementById("father_nss"),u=document.getElementById("father_categorie_sociale"),d=document.getElementById("father_montant_wrapper"),p=document.getElementById("father_montant_s");o&&(o.addEventListener("keypress",m=>{(!/[0-9]/.test(m.key)||o.value.length>=18)&&m.preventDefault()}),o.addEventListener("paste",m=>{setTimeout(()=>{o.value=o.value.replace(/\D/g,"").slice(0,18)},0)})),i&&(i.addEventListener("keypress",m=>{(!/[0-9]/.test(m.key)||i.value.length>=12)&&m.preventDefault()}),i.addEventListener("paste",m=>{setTimeout(()=>{i.value=i.value.replace(/\D/g,"").slice(0,12)},0)})),u&&d&&p&&u.addEventListener("change",function(){this.value==="الدخل الشهري أقل أو يساوي مبلغ الأجر الوطني الأدنى المضمون"?(d.style.display="block",p.required=!0):(d.style.display="none",p.required=!1,p.value="")})}function U(){const o=document.getElementById("mother_simple_nin"),i=document.getElementById("mother_simple_nss"),u=document.getElementById("mother_simple_categorie_sociale"),d=document.getElementById("mother_simple_montant_wrapper"),p=document.getElementById("mother_simple_montant_s");o&&(o.addEventListener("keypress",m=>{(!/[0-9]/.test(m.key)||o.value.length>=18)&&m.preventDefault()}),o.addEventListener("paste",m=>{setTimeout(()=>{o.value=o.value.replace(/\D/g,"").slice(0,18)},0)})),i&&(i.addEventListener("keypress",m=>{(!/[0-9]/.test(m.key)||i.value.length>=12)&&m.preventDefault()}),i.addEventListener("paste",m=>{setTimeout(()=>{i.value=i.value.replace(/\D/g,"").slice(0,12)},0)})),u&&d&&p&&u.addEventListener("change",function(){this.value==="الدخل الشهري أقل أو يساوي مبلغ الأجر الوطني الأدنى المضمون"?(d.style.display="block",p.required=!0):(d.style.display="none",p.required=!1,p.value="")})}document.addEventListener("DOMContentLoaded",()=>{const o=document.getElementById("relation_tuteur");o&&o.addEventListener("change",function(){Q(this.value)});const i=document.getElementById("add-mother-btn");i&&i.addEventListener("click",Z);const u=document.getElementById("wilayaSelectSignup"),d=document.getElementById("communeSelectSignup");if(u&&d){async function r(){try{u.innerHTML='<option value="">جارٍ التحميل...</option>';const e=await(await fetch("/api/wilayas")).json(),n=Array.isArray(e)?e:e.data||[];u.innerHTML='<option value="">اختر...</option>',Array.isArray(n)&&n.forEach(l=>{u.innerHTML+=`<option value="${l.code_wil}">${l.lib_wil_ar}</option>`})}catch(s){console.error("خطأ في تحميل الولايات:",s),u.innerHTML='<option value="">تعذر تحميل البيانات</option>'}}async function a(s){try{d.innerHTML='<option value="">جارٍ التحميل...</option>',d.disabled=!0;const n=await(await fetch(`/api/communes/by-wilaya/${s}`)).json(),l=Array.isArray(n)?n:n.data||[];d.innerHTML='<option value="">اختر...</option>',Array.isArray(l)&&l.forEach(t=>{d.innerHTML+=`<option value="${t.code_comm}">${t.lib_comm_ar}</option>`}),d.disabled=!1}catch(e){console.error("خطأ في تحميل البلديات:",e),d.innerHTML='<option value="">تعذر تحميل البيانات</option>'}}u.addEventListener("change",s=>{const e=s.target.value;e?a(e):(d.innerHTML='<option value="">اختر الولاية أولا...</option>',d.disabled=!0)}),r()}const p=document.getElementById("wilaya_carte"),m=document.getElementById("commune_carte");if(p&&m){async function r(){try{p.innerHTML='<option value="">جارٍ التحميل...</option>';const e=await(await fetch("/api/wilayas")).json(),n=Array.isArray(e)?e:e.data||[];p.innerHTML='<option value="">-- اختر الولاية --</option>',Array.isArray(n)&&n.forEach(l=>p.innerHTML+=`<option value="${l.code_wil}">${l.lib_wil_ar}</option>`)}catch(s){console.error("خطأ في تحميل ولايات البطاقة:",s),p.innerHTML='<option value="">تعذر تحميل البيانات</option>'}}async function a(s){try{m.innerHTML='<option value="">جارٍ التحميل...</option>',m.disabled=!0;const n=await(await fetch(`/api/communes/by-wilaya/${s}`)).json(),l=Array.isArray(n)?n:n.data||[];m.innerHTML='<option value="">-- اختر البلدية --</option>',Array.isArray(l)&&l.forEach(t=>m.innerHTML+=`<option value="${t.code_comm}">${t.lib_comm_ar}</option>`),m.disabled=!1}catch(e){console.error("خطأ في تحميل بلديات البطاقة:",e),m.innerHTML='<option value="">تعذر تحميل البيانات</option>'}}p.addEventListener("change",s=>{const e=s.target.value;e?a(e):(m.innerHTML='<option value="">اختر الولاية أولا...</option>',m.disabled=!0)}),r()}const S=document.getElementById("categorie_sociale"),q=document.getElementById("montant_s_wrapper"),I=document.getElementById("montant_s");S&&q&&I&&S.addEventListener("change",function(){this.value==="الدخل الشهري أقل أو يساوي مبلغ الأجر الوطني الأدنى المضمون"?(q.style.display="block",I.required=!0):(q.style.display="none",I.required=!1,I.value="")}),B();const T=document.querySelectorAll(".form-step"),O=document.querySelectorAll(".next-step"),j=document.querySelectorAll(".prev-step"),V=document.getElementById("progress"),A=document.querySelectorAll(".progress-step");let E=0;function C(){T.forEach((r,a)=>r.classList.toggle("active",a===E)),A.forEach((r,a)=>r.classList.toggle("active",a<=E)),V.style.width=E/(A.length-1)*100+"%",N(),K()}function y(r,a){if(f(r),!a)return;const s=document.createElement("div");s.className="error-message",s.textContent=a,(r.closest(".password-wrapper")||r).insertAdjacentElement("afterend",s),r.classList.add("invalid"),r.classList.remove("valid")}function R(r){f(r),r.classList.add("valid"),r.classList.remove("invalid")}function f(r){(r.closest(".password-wrapper")||r).parentNode.querySelectorAll(".error-message").forEach(e=>e.remove())}window.setupMotherArabicValidation=function(r){const a=document.getElementById(`mother_${r}_nom_ar`),s=document.getElementById(`mother_${r}_prenom_ar`);[a,s].forEach(e=>{if(!e)return;const n=/^[\u0600-\u06FF\s]+$/;e.addEventListener("keypress",function(l){const t=l.key;/^[\u0600-\u06FF\s]$/.test(t)||(l.preventDefault(),y(this,"يرجى الإدخال باللغة العربية فقط"),this.classList.add("invalid"),this.classList.remove("valid"))}),e.addEventListener("input",function(){const l=this.value.trim();if(l===""){f(this),this.classList.remove("valid","invalid");return}n.test(l)?(f(this),this.classList.add("valid"),this.classList.remove("invalid")):(y(this,"يرجى الإدخال باللغة العربية فقط"),this.classList.add("invalid"),this.classList.remove("valid"))}),e.addEventListener("blur",function(){const l=this.value.trim();if(l===""){f(this),this.classList.remove("valid","invalid");return}n.test(l)||(y(this,"يرجى الإدخال باللغة العربية فقط"),this.classList.add("invalid"),this.classList.remove("valid"))})})},window.setupMotherNINValidation=function(r){const a=document.getElementById(`mother_${r}_nin`);if(!a)return;let s=null;a.addEventListener("keypress",function(e){[8,9,27,13,46].indexOf(e.keyCode)!==-1||e.keyCode===65&&e.ctrlKey===!0||e.keyCode===67&&e.ctrlKey===!0||e.keyCode===86&&e.ctrlKey===!0||e.keyCode===88&&e.ctrlKey===!0||e.keyCode>=35&&e.keyCode<=39||((e.shiftKey||e.keyCode<48||e.keyCode>57)&&(e.keyCode<96||e.keyCode>105)&&e.preventDefault(),this.value.length>=18&&e.preventDefault())}),a.addEventListener("input",function(){this.value=this.value.replace(/\D/g,""),this.value.length>18&&(this.value=this.value.slice(0,18));const e=this.value.trim();if(s&&clearTimeout(s),e===""){f(this),this.classList.remove("valid","invalid");return}e.length===18?(s=setTimeout(async()=>{try{(await(await fetch("/api/check/mother/nin",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.content||""},body:JSON.stringify({nin:e})})).json()).exists?(y(a,"هذا الرقم الوطني موجود بالفعل"),a.classList.add("invalid"),a.classList.remove("valid")):(f(a),a.classList.add("valid"),a.classList.remove("invalid"))}catch(n){console.error("Error checking NIN:",n),f(a),a.classList.add("valid"),a.classList.remove("invalid")}},500),f(a),a.classList.remove("invalid")):(y(this,`الرقم الوطني يجب أن يحتوي على 18 رقمًا (${e.length}/18)`),this.classList.add("invalid"),this.classList.remove("valid"))}),a.addEventListener("blur",async function(){const e=this.value.trim();if(e===""){f(this),this.classList.remove("valid","invalid");return}if(e.length!==18)y(this,"الرقم الوطني يجب أن يحتوي على 18 رقمًا"),this.classList.add("invalid"),this.classList.remove("valid");else try{(await(await fetch("/api/check/mother/nin",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.content||""},body:JSON.stringify({nin:e})})).json()).exists?(y(this,"هذا الرقم الوطني موجود بالفعل"),this.classList.add("invalid"),this.classList.remove("valid")):(f(this),this.classList.add("valid"),this.classList.remove("invalid"))}catch(n){console.error("Error checking NIN:",n),f(this),this.classList.add("valid"),this.classList.remove("invalid")}})},window.setupMotherNSSValidation=function(r){const a=document.getElementById(`mother_${r}_nss`);if(!a)return;let s=null;a.addEventListener("keypress",function(e){[8,9,27,13,46].indexOf(e.keyCode)!==-1||e.keyCode===65&&e.ctrlKey===!0||e.keyCode===67&&e.ctrlKey===!0||e.keyCode===86&&e.ctrlKey===!0||e.keyCode===88&&e.ctrlKey===!0||e.keyCode>=35&&e.keyCode<=39||((e.shiftKey||e.keyCode<48||e.keyCode>57)&&(e.keyCode<96||e.keyCode>105)&&e.preventDefault(),this.value.length>=12&&e.preventDefault())}),a.addEventListener("paste",function(e){e.preventDefault();const l=(e.clipboardData||window.clipboardData).getData("text").replace(/\D/g,"").slice(0,12);this.value=l,this.dispatchEvent(new Event("input"))}),a.addEventListener("input",function(){this.value=this.value.replace(/\D/g,""),this.value.length>12&&(this.value=this.value.slice(0,12));const e=this.value.trim();if(s&&clearTimeout(s),e===""){f(this),this.classList.remove("valid","invalid");return}e.length===12?(s=setTimeout(async()=>{try{(await(await fetch("/api/check/mother/nss",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.content||""},body:JSON.stringify({nss:e})})).json()).exists?(y(a,"هذا رقم الضمان الاجتماعي موجود بالفعل"),a.classList.add("invalid"),a.classList.remove("valid")):(f(a),a.classList.add("valid"),a.classList.remove("invalid"))}catch(n){console.error("Error checking NSS:",n),f(a),a.classList.add("valid"),a.classList.remove("invalid")}},500),f(a),a.classList.remove("invalid")):(y(this,`رقم الضمان الاجتماعي يجب أن يحتوي على 12 رقمًا (${e.length}/12)`),this.classList.add("invalid"),this.classList.remove("valid"))}),a.addEventListener("blur",async function(){const e=this.value.trim();if(e===""){f(this),this.classList.remove("valid","invalid");return}if(e.length!==12)y(this,"رقم الضمان الاجتماعي يجب أن يحتوي على 12 رقمًا"),this.classList.add("invalid"),this.classList.remove("valid");else try{(await(await fetch("/api/check/mother/nss",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.content||""},body:JSON.stringify({nss:e})})).json()).exists?(y(this,"هذا رقم الضمان الاجتماعي موجود بالفعل"),this.classList.add("invalid"),this.classList.remove("valid")):(f(this),this.classList.add("valid"),this.classList.remove("invalid"))}catch(n){console.error("Error checking NSS:",n),f(this),this.classList.add("valid"),this.classList.remove("invalid")}})};function k(r,a=!0){if(r.disabled)return f(r),r.classList.remove("invalid","valid"),!0;const s=r.value.trim(),e=r.id,n=r.type,l=r.name;f(r);let t=!0,h="";if(n==="radio"){const _=document.querySelectorAll(`input[name="${l}"]`),w=document.querySelector(`input[name="${l}"]:checked`),c=r.closest(".form-group");if(c&&c.querySelectorAll(".error-message").forEach(v=>v.remove()),!w&&(t=!1,h="هذا الحقل مطلوب",a&&c)){const v=document.createElement("div");v.className="error-message",v.textContent=h,c.appendChild(v)}return _.forEach(v=>{v.classList.toggle("valid",t),v.classList.toggle("invalid",!t)}),t}if(r.tagName.toLowerCase()==="select"&&r.hasAttribute("required")&&(s===""||s==="none")&&(t=!1,h="هذا الحقل مطلوب"),r.hasAttribute("required")&&s===""&&(t=!1,h="هذا الحقل مطلوب"),t&&s!=="")switch(e){case"nin":/^\d{18}$/.test(s)||(t=!1,h="يجب أن يحتوي الرقم التعريفي الوطني على 18 رقمًا بالضبط");break;case"email":/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s)||(t=!1,h="البريد الإلكتروني غير صالح");break;case"phone":/^\d{10}$/.test(s)||(t=!1,h="رقم الهاتف يجب أن يحتوي على 10 أرقام");break;case"password":/^(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&]).{8,}$/.test(s)||(t=!1,h="كلمة المرور ضعيفة، يجب أن تحتوي على حرف كبير، رقم، ورمز خاص");break;case"confirm_password":const _=document.getElementById("password").value;s!==_&&(t=!1,h="كلمة المرور غير مطابقة");break;case"date_naissance":const w=new Date;new Date(s)>w&&(t=!1,h="تاريخ الميلاد لا يمكن أن يكون في المستقبل");break;case"num_carte":/^\d{9}$/.test(s)||(t=!1,h="يجب أن يحتوي رقم بطاقة التعريف الوطنية على 9 أرقام");break;case"date_carte":const v=new Date;v.setHours(0,0,0,0);const $=new Date(s);if($>v)t=!1,h="تاريخ إصدار البطاقة يجب أن يكون قبل أو يساوي تاريخ اليوم";else{const g=new Date;g.setFullYear(v.getFullYear()-10),g.setHours(0,0,0,0),$<g&&(t=!1,h="تاريخ إصدار البطاقة يجب ألا يتجاوز 10 سنوات من تاريخ اليوم")}break;case"nss":/^\d{12}$/.test(s)||(t=!1,h="رقم الضمان الاجتماعي يجب أن يحتوي على 12 رقمًا بالضبط");break;case"montant_s":if(document.getElementById("categorie_sociale").value!=="عديم الدخل"){const g=parseFloat(s);isNaN(g)||g<=0?(t=!1,h="يرجى إدخال مبلغ صالح (أكبر من 0)"):r.value=g}else r.value="0",t=!0,f(r);break;case"num_cp":/^\d{10}$/.test(s)||(t=!1,h="رقم الحساب البريدي يجب أن يحتوي على 10 أرقام");break;case"cle_ccp":/^\d{2}$/.test(s)||(t=!1,h="الرقم المفتاح يجب أن يحتوي على رقمين اثنين");break}return t?R(r):a?y(r,h):r.classList.remove("valid","invalid"),t}const D=document.getElementById("phone");D&&D.addEventListener("input",function(){const r=this.value.replace(/\D/g,"");this.value!==r?y(this,"يجب إدخال أرقام فقط"):r.length>0&&r.length!==10?y(this,"رقم الهاتف يجب أن يحتوي على 10 أرقام"):(f(this),this.classList.add("valid"),this.classList.remove("invalid")),this.value=r.slice(0,10)}),["nom_ar","prenom_ar"].forEach(r=>{const a=document.getElementById(r);if(!a)return;const s=/^[\u0600-\u06FF\s]+$/;a.addEventListener("keypress",function(e){const n=e.key;/^[\u0600-\u06FF\s]$/.test(n)||(e.preventDefault(),y(this,"يرجى الإدخال باللغة العربية فقط"),this.classList.add("invalid"),this.classList.remove("valid"))}),a.addEventListener("input",function(){const e=this.value.trim();if(e===""){f(this),this.classList.remove("valid","invalid");return}s.test(e)?(f(this),this.classList.add("valid"),this.classList.remove("invalid")):(y(this,"يرجى الإدخال باللغة العربية فقط"),this.classList.add("invalid"),this.classList.remove("valid"))})}),["nom_fr","prenom_fr"].forEach(r=>{const a=document.getElementById(r);if(!a)return;const s=/^[A-Za-zÀ-ÿ\s]+$/;a.addEventListener("keypress",function(e){const n=e.key;/^[\u0600-\u06FF]$/.test(n)&&(e.preventDefault(),y(this,"يرجى الإدخال بالحروف اللاتينية فقط"),this.classList.add("invalid"),this.classList.remove("valid"))}),a.addEventListener("input",function(){const e=this.value.trim();if(e===""){f(this),this.classList.remove("valid","invalid");return}s.test(e)?(f(this),this.classList.add("valid"),this.classList.remove("invalid")):(y(this,"يرجى الإدخال بالحروف اللاتينية فقط"),this.classList.add("invalid"),this.classList.remove("valid"))})});function N(){const r=document.querySelectorAll(".form-step.active input, .form-step.active select"),a=document.getElementById("categorie_sociale"),s=document.getElementById("montant_s"),e=document.getElementById("montant_s_wrapper");a&&s&&e&&(a._changeHandler&&a.removeEventListener("change",a._changeHandler),a._changeHandler=function(){this.value==="الدخل الشهري أقل أو يساوي مبلغ الأجر الوطني الأدنى المضمون"?(e.style.display="block",s.removeAttribute("disabled"),s.setAttribute("required","required"),s.value=""):(e.style.display="none",s.value="",s.removeAttribute("required"),s.removeAttribute("disabled"),s.classList.remove("valid","invalid"),f(s))},a.addEventListener("change",a._changeHandler),a._changeHandler()),r.forEach(n=>{n.removeEventListener("input",n._inputHandler),n.removeEventListener("blur",n._blurHandler),n.id==="nin"&&n.addEventListener("input",()=>{n.value=n.value.replace(/\D/g,"").slice(0,18)}),n.id==="num_carte"&&n.addEventListener("input",()=>{n.value=n.value.replace(/\D/g,"").slice(0,9)}),n.id==="nss"&&n.addEventListener("input",()=>{n.value=n.value.replace(/\D/g,"").slice(0,12)}),n.id==="montant_s"&&n.addEventListener("input",()=>{parseFloat(n.value)<0&&(n.value="")}),n.id==="num_cp"&&n.addEventListener("input",()=>{n.value=n.value.replace(/\D/g,"").slice(0,10)}),n.id==="cle_ccp"&&n.addEventListener("input",()=>{n.value=n.value.replace(/\D/g,"").slice(0,2)}),n.id==="date_carte"?(n.addEventListener("change",()=>{n.value.trim()!==""&&k(n,!0)}),n._inputHandler=()=>{n.value.trim()!==""&&k(n,!0)}):n._inputHandler=()=>{n.value.trim()!==""&&k(n,!1)},n.addEventListener("input",n._inputHandler),n._blurHandler=()=>{n.value.trim()!==""&&k(n,!0)},n.addEventListener("blur",n._blurHandler)})}function K(){const r=document.getElementById("categorie_sociale"),a=document.getElementById("montant_s"),s=document.getElementById("montant_s_wrapper");r&&a&&s&&(r.value==="عديم الدخل"||r.value===""?(s.style.display="none",a.value="",a.removeAttribute("required"),f(a)):r.value==="الدخل الشهري أقل أو يساوي مبلغ الأجر الوطني الأدنى المضمون"&&(s.style.display="block",a.removeAttribute("disabled"),a.setAttribute("required","required"),a.value==="0"&&(a.value="")))}function W(){const r=document.querySelector(".form-step.active"),a=r.querySelectorAll("input[required], select[required]");let s=!0,e=[];return r.querySelectorAll(".error-message").forEach(n=>n.remove()),a.forEach(n=>{const l=n.closest("#montant_s_wrapper");if(!(l&&window.getComputedStyle(l).display==="none")&&!k(n,!0)){s=!1;const t=n.closest(".form-group")?.querySelector("label")?.textContent||n.name;e.push(t)}}),a.forEach(n=>{if(!(n.disabled&&n.id!=="montant_s")&&!k(n,!0)){s=!1;const l=n.closest(".form-group")?.querySelector("label")?.textContent||n.name;e.includes(l)||e.push(l)}}),!s&&typeof Swal<"u"&&Swal.fire({icon:"warning",title:"يرجى إكمال البيانات",html:`الحقول التالية مطلوبة أو تحتوي على أخطاء:<br><b>${e.join("<br>")}</b>`,confirmButtonText:"حسنًا"}),s}O.forEach(r=>{r.addEventListener("click",()=>{(E===0||E===1)&&!W()||E<T.length-1&&(E++,C())})}),j.forEach(r=>{r.addEventListener("click",()=>{E>0&&(E--,C())})});const x=document.getElementById("signupForm");function P(r,a){if(r=r.trim(),a=a.trim(),!/^\d+$/.test(r)||!/^\d+$/.test(a))return!1;const e=parseInt(r,10)*100%97,l=(97-(e+85>97?e+85-97:e+85)).toString().padStart(2,"0");return a===l}x&&(x.noValidate=!0,x.addEventListener("submit",async r=>{r.preventDefault();let a=!0,s=[];document.querySelectorAll(".error-message").forEach(c=>c.remove()),x.querySelectorAll("input[required], select[required]").forEach(c=>{if(!k(c,!0)){a=!1;const v=c.closest(".form-group, .col-md-3")?.querySelector("label")?.textContent||c.name;s.includes(v)||s.push(v)}});const n=x.querySelector('input[name="gender"]:checked');n||(a=!1,s.includes("الجنس")||s.push("الجنس"));const l=document.getElementById("agreement_checkbox");if(!l||!l.checked?(a=!1,s.includes("الموافقة على القوانين")||s.push("الموافقة على القوانين"),l&&(l.style.outline="2px solid #ef4444",l.style.outlineOffset="2px")):l&&(l.style.outline="",l.style.outlineOffset=""),!a){Swal.fire({icon:"warning",title:"يرجى إكمال البيانات",html:`الحقول التالية مطلوبة أو تحتوي على أخطاء:<br><b>${s.join("<br>")}</b>`,confirmButtonText:"حسنًا"});return}const t=Object.fromEntries(new FormData(x).entries()),h=t.relation_tuteur;if(!h){Swal.fire({icon:"warning",title:"يرجى اختيار صفة طالب المنحة",text:"يجب اختيار صفة طالب المنحة قبل المتابعة",confirmButtonText:"حسنًا"});return}const _={nin:t.nin,email:t.email,tel:t.phone,password:t.password,nom_ar:t.nom_ar,prenom_ar:t.prenom_ar,nom_fr:t.nom_fr,prenom_fr:t.prenom_fr,sexe:n.value==="male"?"ذكر":"أنثى",date_naiss:t.date_naissance,presume:t.presume?"1":"0",commune_naiss:document.getElementById("communeSelectSignup")?.value||null,adresse:t.adresse,nbr_enfants_scolarise:t.nbr_enfants,num_cni:t.num_carte,date_cni:t.date_carte,lieu_cni:document.getElementById("commune_carte")?.value||null,nss:t.nss,num_cpt:t.num_cp,cle_cpt:t.cle_ccp,cats:t.categorie_sociale,montant_s:t.categorie_sociale==="الدخل الشهري أقل أو يساوي مبلغ الأجر الوطني الأدنى المضمون"&&t.montant_s||null,autr_info:t.autre_info||"",code_commune:document.getElementById("communeSelectSignup")?.value||null,relation_tuteur:h};if(h==="1"){const c=[];document.querySelectorAll(".mother-fields").forEach(($,J)=>{const g=$.dataset.motherIndex,b={nin:t[`mother_${g}_nin`],nss:t[`mother_${g}_nss`],nom_ar:t[`mother_${g}_nom_ar`],prenom_ar:t[`mother_${g}_prenom_ar`],nom_fr:t[`mother_${g}_nom_fr`]||null,prenom_fr:t[`mother_${g}_prenom_fr`]||null,categorie_sociale:t[`mother_${g}_categorie_sociale`],montant_s:t[`mother_${g}_montant_s`]||null};b.nin&&b.nss&&b.nom_ar&&b.prenom_ar&&b.categorie_sociale&&(b.nin=String(b.nin).replace(/\D/g,"").slice(0,18),b.nss=String(b.nss).replace(/\D/g,"").slice(0,12),b.nin.length===18&&b.nss.length===12&&c.push(b))}),c.length>0&&(_.mothers=c)}else h==="2"?t.father_nin&&t.father_nss&&t.father_nom_ar&&t.father_prenom_ar&&(_.father={nin:String(t.father_nin).replace(/\D/g,"").slice(0,18),nss:String(t.father_nss).replace(/\D/g,"").slice(0,12),nom_ar:t.father_nom_ar,prenom_ar:t.father_prenom_ar,nom_fr:t.father_nom_fr||null,prenom_fr:t.father_prenom_fr||null,categorie_sociale:t.father_categorie_sociale,montant_s:t.father_montant_s||null}):h==="3"&&(t.father_nin&&t.father_nss&&t.father_nom_ar&&t.father_prenom_ar&&(_.father={nin:String(t.father_nin).replace(/\D/g,"").slice(0,18),nss:String(t.father_nss).replace(/\D/g,"").slice(0,12),nom_ar:t.father_nom_ar,prenom_ar:t.father_prenom_ar,nom_fr:t.father_nom_fr||null,prenom_fr:t.father_prenom_fr||null,categorie_sociale:t.father_categorie_sociale,montant_s:t.father_montant_s||null}),t.mother_simple_nin&&t.mother_simple_nss&&t.mother_simple_nom_ar&&t.mother_simple_prenom_ar&&(_.mother={nin:String(t.mother_simple_nin).replace(/\D/g,"").slice(0,18),nss:String(t.mother_simple_nss).replace(/\D/g,"").slice(0,12),nom_ar:t.mother_simple_nom_ar,prenom_ar:t.mother_simple_prenom_ar,nom_fr:t.mother_simple_nom_fr||null,prenom_fr:t.mother_simple_prenom_fr||null,categorie_sociale:t.mother_simple_categorie_sociale,montant_s:t.mother_simple_montant_s||null}));if(!P(_.num_cpt,_.cle_cpt)){Swal.fire({icon:"warning",title:" CCP خطأ في",text:"رقم CCP أو مفتاح CCP غير صحيح. يرجى التحقق.",confirmButtonText:"حسنًا"});return}const w=new FormData;for(const c in _)_[c]!==void 0&&_[c]!==null&&(c==="mothers"&&Array.isArray(_[c])||c==="father"&&typeof _[c]=="object"||c==="mother"&&typeof _[c]=="object"?w.append(c,JSON.stringify(_[c])):w.append(c,_[c]));try{Swal.fire({title:"جاري الإرسال...",text:"الرجاء الانتظار قليلاً",allowOutsideClick:!1,didOpen:()=>Swal.showLoading()});const c=await fetch("/api/tuteurs",{method:"POST",body:w,headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content,Accept:"application/json"}}),v=await c.json();if(Swal.close(),c.status===422){const $=Object.values(v.errors||{}).flat().join("<br>");Swal.fire({icon:"warning",title:"تحقق من البيانات",html:$,confirmButtonText:"حسنًا",customClass:{confirmButton:"swal-confirm-btn"},buttonsStyling:!1});return}if(!c.ok){Swal.fire({icon:"error",title:"حدث خطأ أثناء التسجيل",text:v.message||"يرجى المحاولة لاحقًا.",confirmButtonText:"حسنًا",customClass:{confirmButton:"swal-confirm-btn"},buttonsStyling:!1});return}Swal.fire({icon:"success",title:"✅ تم التسجيل بنجاح!",text:"يمكنك الآن تسجيل الدخول إلى حسابك.",confirmButtonText:"حسنًا",customClass:{confirmButton:"swal-confirm-btn"},buttonsStyling:!1}).then(()=>{window.location.href="/login"})}catch(c){console.error("❌ Fetch error:",c),Swal.close(),Swal.fire({icon:"error",title:"خطأ في الاتصال بالخادم",text:"تحقق من الاتصال بالخادم المحلي أو الشبكة."})}})),Y(),N(),C()});document.querySelectorAll(".toggle-password").forEach(o=>{o.addEventListener("click",()=>{const i=o.closest(".password-wrapper").querySelector("input");i.type==="password"?(i.type="text",o.classList.replace("fa-eye","fa-eye-slash")):(i.type="password",o.classList.replace("fa-eye-slash","fa-eye"))})});
