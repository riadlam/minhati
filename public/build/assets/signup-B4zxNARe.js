function Y(){document.querySelectorAll("#signupForm .form-group").forEach(f=>{const u=f.querySelector("input[required], select[required], textarea[required]"),g=f.querySelector("label");if(u&&!u.disabled&&g&&!g.querySelector(".text-danger")){const v=document.createElement("span");v.className="text-danger",v.textContent=" *",g.appendChild(v)}})}const Z=new Date("2026-03-01T00:00:00");function U(){const f=document.getElementById("signupForm"),u=document.getElementById("deadlineAlert");if(!f)return;const v=new Date>=Z;u&&u.classList.toggle("d-none",!v),v&&f.querySelectorAll("input, select, textarea, button").forEach(L=>{L.type!=="hidden"&&(L.disabled=!0)})}document.addEventListener("DOMContentLoaded",()=>{const f=document.getElementById("wilayaSelectSignup"),u=document.getElementById("communeSelectSignup");if(f&&u){async function n(){try{f.innerHTML='<option value="">جارٍ التحميل...</option>';const e=await(await fetch("/api/wilayas")).json(),t=Array.isArray(e)?e:e.data||[];f.innerHTML='<option value="">اختر...</option>',Array.isArray(t)&&t.forEach(a=>{f.innerHTML+=`<option value="${a.code_wil}">${a.lib_wil_ar}</option>`})}catch(s){console.error("خطأ في تحميل الولايات:",s),f.innerHTML='<option value="">تعذر تحميل البيانات</option>'}}async function i(s){try{u.innerHTML='<option value="">جارٍ التحميل...</option>',u.disabled=!0;const t=await(await fetch(`/api/communes/by-wilaya/${s}`)).json(),a=Array.isArray(t)?t:t.data||[];u.innerHTML='<option value="">اختر...</option>',Array.isArray(a)&&a.forEach(r=>{u.innerHTML+=`<option value="${r.code_comm}">${r.lib_comm_ar}</option>`}),u.disabled=!1}catch(e){console.error("خطأ في تحميل البلديات:",e),u.innerHTML='<option value="">تعذر تحميل البيانات</option>'}}f.addEventListener("change",s=>{const e=s.target.value;e?i(e):(u.innerHTML='<option value="">اختر الولاية أولا...</option>',u.disabled=!0)}),n()}const g=document.getElementById("wilaya_carte"),v=document.getElementById("commune_carte");if(g&&v){async function n(){try{g.innerHTML='<option value="">جارٍ التحميل...</option>';const e=await(await fetch("/api/wilayas")).json(),t=Array.isArray(e)?e:e.data||[];g.innerHTML='<option value="">-- اختر الولاية --</option>',Array.isArray(t)&&t.forEach(a=>g.innerHTML+=`<option value="${a.code_wil}">${a.lib_wil_ar}</option>`)}catch(s){console.error("خطأ في تحميل ولايات البطاقة:",s),g.innerHTML='<option value="">تعذر تحميل البيانات</option>'}}async function i(s){try{v.innerHTML='<option value="">جارٍ التحميل...</option>',v.disabled=!0;const t=await(await fetch(`/api/communes/by-wilaya/${s}`)).json(),a=Array.isArray(t)?t:t.data||[];v.innerHTML='<option value="">-- اختر البلدية --</option>',Array.isArray(a)&&a.forEach(r=>v.innerHTML+=`<option value="${r.code_comm}">${r.lib_comm_ar}</option>`),v.disabled=!1}catch(e){console.error("خطأ في تحميل بلديات البطاقة:",e),v.innerHTML='<option value="">تعذر تحميل البيانات</option>'}}g.addEventListener("change",s=>{const e=s.target.value;e?i(e):(v.innerHTML='<option value="">اختر الولاية أولا...</option>',v.disabled=!0)}),n()}const L=document.getElementById("categorie_sociale"),D=document.getElementById("montant_s_wrapper"),F=document.getElementById("montant_s"),I=document.getElementById("certificate_of_none_income_wrapper"),w=document.getElementById("Certificate_of_none_income"),C=document.getElementById("certificate_of_non_affiliation_wrapper"),S=document.getElementById("Certificate_of_non_affiliation_to_social_security"),x=document.getElementById("crossed_ccp_wrapper"),q=document.getElementById("crossed_ccp"),N=document.getElementById("salary_certificate_wrapper"),B=document.getElementById("salary_certificate");function H(){const n=L?L.value:"";n==="عديم الدخل"?(I&&(I.style.display="block"),w&&w.setAttribute("required","required"),C&&(C.style.display="block"),S&&S.setAttribute("required","required"),x&&(x.style.display="none"),q&&(q.removeAttribute("required"),q.value="")):n==="الدخل الشهري أقل أو يساوي مبلغ الأجر الوطني الأدنى المضمون"?(x&&(x.style.display="block"),q&&q.setAttribute("required","required"),N&&(N.style.display="block"),B&&B.setAttribute("required","required"),I&&(I.style.display="none"),w&&(w.removeAttribute("required"),w.value=""),C&&(C.style.display="none"),S&&(S.removeAttribute("required"),S.value="")):(I&&(I.style.display="none"),w&&(w.removeAttribute("required"),w.value=""),C&&(C.style.display="none"),S&&(S.removeAttribute("required"),S.value=""),x&&(x.style.display="none"),q&&(q.removeAttribute("required"),q.value=""),N&&(N.style.display="none"),B&&(B.removeAttribute("required"),B.value=""))}L&&D&&F&&(L.addEventListener("change",function(){this.value==="الدخل الشهري أقل أو يساوي مبلغ الأجر الوطني الأدنى المضمون"?(D.style.display="block",F.required=!0):(D.style.display="none",F.required=!1,F.value=""),H()}),H()),Y();const M=document.querySelectorAll(".form-step"),K=document.querySelectorAll(".next-step"),P=document.querySelectorAll(".prev-step"),V=document.getElementById("progress"),j=document.querySelectorAll(".progress-step");let E=0;function $(){M.forEach((n,i)=>n.classList.toggle("active",i===E)),j.forEach((n,i)=>n.classList.toggle("active",i<=E)),V.style.width=E/(j.length-1)*100+"%",W(),X()}function m(n,i){if(d(n),!i)return;const s=document.createElement("div");s.className="error-message",s.textContent=i,(n.closest(".password-wrapper")||n).insertAdjacentElement("afterend",s),n.classList.add("invalid"),n.classList.remove("valid")}function J(n){d(n),n.classList.add("valid"),n.classList.remove("invalid")}function d(n){(n.closest(".password-wrapper")||n).parentNode.querySelectorAll(".error-message").forEach(e=>e.remove())}window.setupMotherArabicValidation=function(n){const i=document.getElementById(`mother_${n}_nom_ar`),s=document.getElementById(`mother_${n}_prenom_ar`);[i,s].forEach(e=>{if(!e)return;const t=/^[\u0600-\u06FF\s]+$/;e.addEventListener("keypress",function(a){const r=a.key;/^[\u0600-\u06FF\s]$/.test(r)||(a.preventDefault(),m(this,"يرجى الإدخال باللغة العربية فقط"),this.classList.add("invalid"),this.classList.remove("valid"))}),e.addEventListener("input",function(){const a=this.value.trim();if(a===""){d(this),this.classList.remove("valid","invalid");return}t.test(a)?(d(this),this.classList.add("valid"),this.classList.remove("invalid")):(m(this,"يرجى الإدخال باللغة العربية فقط"),this.classList.add("invalid"),this.classList.remove("valid"))}),e.addEventListener("blur",function(){const a=this.value.trim();if(a===""){d(this),this.classList.remove("valid","invalid");return}t.test(a)||(m(this,"يرجى الإدخال باللغة العربية فقط"),this.classList.add("invalid"),this.classList.remove("valid"))})})},window.setupMotherNINValidation=function(n){const i=document.getElementById(`mother_${n}_nin`);if(!i)return;let s=null;i.addEventListener("keypress",function(e){[8,9,27,13,46].indexOf(e.keyCode)!==-1||e.keyCode===65&&e.ctrlKey===!0||e.keyCode===67&&e.ctrlKey===!0||e.keyCode===86&&e.ctrlKey===!0||e.keyCode===88&&e.ctrlKey===!0||e.keyCode>=35&&e.keyCode<=39||((e.shiftKey||e.keyCode<48||e.keyCode>57)&&(e.keyCode<96||e.keyCode>105)&&e.preventDefault(),this.value.length>=18&&e.preventDefault())}),i.addEventListener("input",function(){this.value=this.value.replace(/\D/g,""),this.value.length>18&&(this.value=this.value.slice(0,18));const e=this.value.trim();if(s&&clearTimeout(s),e===""){d(this),this.classList.remove("valid","invalid");return}e.length===18?(s=setTimeout(async()=>{try{(await(await fetch("/api/check/mother/nin",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.content||""},body:JSON.stringify({nin:e})})).json()).exists?(m(i,"هذا الرقم الوطني موجود بالفعل"),i.classList.add("invalid"),i.classList.remove("valid")):(d(i),i.classList.add("valid"),i.classList.remove("invalid"))}catch(t){console.error("Error checking NIN:",t),d(i),i.classList.add("valid"),i.classList.remove("invalid")}},500),d(i),i.classList.remove("invalid")):(m(this,`الرقم الوطني يجب أن يحتوي على 18 رقمًا (${e.length}/18)`),this.classList.add("invalid"),this.classList.remove("valid"))}),i.addEventListener("blur",async function(){const e=this.value.trim();if(e===""){d(this),this.classList.remove("valid","invalid");return}if(e.length!==18)m(this,"الرقم الوطني يجب أن يحتوي على 18 رقمًا"),this.classList.add("invalid"),this.classList.remove("valid");else try{(await(await fetch("/api/check/mother/nin",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.content||""},body:JSON.stringify({nin:e})})).json()).exists?(m(this,"هذا الرقم الوطني موجود بالفعل"),this.classList.add("invalid"),this.classList.remove("valid")):(d(this),this.classList.add("valid"),this.classList.remove("invalid"))}catch(t){console.error("Error checking NIN:",t),d(this),this.classList.add("valid"),this.classList.remove("invalid")}})},window.setupMotherNSSValidation=function(n){const i=document.getElementById(`mother_${n}_nss`);if(!i)return;let s=null;i.addEventListener("keypress",function(e){[8,9,27,13,46].indexOf(e.keyCode)!==-1||e.keyCode===65&&e.ctrlKey===!0||e.keyCode===67&&e.ctrlKey===!0||e.keyCode===86&&e.ctrlKey===!0||e.keyCode===88&&e.ctrlKey===!0||e.keyCode>=35&&e.keyCode<=39||((e.shiftKey||e.keyCode<48||e.keyCode>57)&&(e.keyCode<96||e.keyCode>105)&&e.preventDefault(),this.value.length>=12&&e.preventDefault())}),i.addEventListener("paste",function(e){e.preventDefault();const a=(e.clipboardData||window.clipboardData).getData("text").replace(/\D/g,"").slice(0,12);this.value=a,this.dispatchEvent(new Event("input"))}),i.addEventListener("input",function(){this.value=this.value.replace(/\D/g,""),this.value.length>12&&(this.value=this.value.slice(0,12));const e=this.value.trim();if(s&&clearTimeout(s),e===""){d(this),this.classList.remove("valid","invalid");return}e.length===12?(s=setTimeout(async()=>{try{(await(await fetch("/api/check/mother/nss",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.content||""},body:JSON.stringify({nss:e})})).json()).exists?(m(i,"هذا رقم الضمان الاجتماعي موجود بالفعل"),i.classList.add("invalid"),i.classList.remove("valid")):(d(i),i.classList.add("valid"),i.classList.remove("invalid"))}catch(t){console.error("Error checking NSS:",t),d(i),i.classList.add("valid"),i.classList.remove("invalid")}},500),d(i),i.classList.remove("invalid")):(m(this,`رقم الضمان الاجتماعي يجب أن يحتوي على 12 رقمًا (${e.length}/12)`),this.classList.add("invalid"),this.classList.remove("valid"))}),i.addEventListener("blur",async function(){const e=this.value.trim();if(e===""){d(this),this.classList.remove("valid","invalid");return}if(e.length!==12)m(this,"رقم الضمان الاجتماعي يجب أن يحتوي على 12 رقمًا"),this.classList.add("invalid"),this.classList.remove("valid");else try{(await(await fetch("/api/check/mother/nss",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.content||""},body:JSON.stringify({nss:e})})).json()).exists?(m(this,"هذا رقم الضمان الاجتماعي موجود بالفعل"),this.classList.add("invalid"),this.classList.remove("valid")):(d(this),this.classList.add("valid"),this.classList.remove("invalid"))}catch(t){console.error("Error checking NSS:",t),d(this),this.classList.add("valid"),this.classList.remove("invalid")}})};function A(n,i=!0){if(n.disabled)return d(n),n.classList.remove("invalid","valid"),!0;const s=n.value.trim(),e=n.id,t=n.type,a=n.name;d(n);let r=!0,o="";if(t==="radio"){const p=document.querySelectorAll(`input[name="${a}"]`),l=document.querySelector(`input[name="${a}"]:checked`),b=n.closest(".form-group");if(b&&b.querySelectorAll(".error-message").forEach(h=>h.remove()),!l&&(r=!1,o="هذا الحقل مطلوب",i&&b)){const h=document.createElement("div");h.className="error-message",h.textContent=o,b.appendChild(h)}return p.forEach(h=>{h.classList.toggle("valid",r),h.classList.toggle("invalid",!r)}),r}if(n.tagName.toLowerCase()==="select"&&n.hasAttribute("required")&&(s===""||s==="none")&&(r=!1,o="هذا الحقل مطلوب"),n.hasAttribute("required")&&s===""&&(r=!1,o="هذا الحقل مطلوب"),r&&s!=="")switch(e){case"nin":/^\d{18}$/.test(s)||(r=!1,o="يجب أن يحتوي الرقم التعريفي الوطني على 18 رقمًا بالضبط");break;case"email":/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s)||(r=!1,o="البريد الإلكتروني غير صالح");break;case"phone":/^\d{10}$/.test(s)||(r=!1,o="رقم الهاتف يجب أن يحتوي على 10 أرقام");break;case"password":/^(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&]).{8,}$/.test(s)||(r=!1,o="كلمة المرور ضعيفة، يجب أن تحتوي على حرف كبير، رقم، ورمز خاص");break;case"confirm_password":const p=document.getElementById("password").value;s!==p&&(r=!1,o="كلمة المرور غير مطابقة");break;case"date_naissance":const l=new Date;new Date(s)>l&&(r=!1,o="تاريخ الميلاد لا يمكن أن يكون في المستقبل");break;case"num_carte":/^\d{9}$/.test(s)||(r=!1,o="يجب أن يحتوي رقم بطاقة التعريف الوطنية على 9 أرقام");break;case"date_carte":const h=new Date;h.setHours(0,0,0,0);const O=new Date(s);if(O>h)r=!1,o="تاريخ إصدار البطاقة يجب أن يكون قبل أو يساوي تاريخ اليوم";else{const _=new Date;_.setFullYear(h.getFullYear()-10),_.setHours(0,0,0,0),O<_&&(r=!1,o="تاريخ إصدار البطاقة يجب ألا يتجاوز 10 سنوات من تاريخ اليوم")}break;case"nss":/^\d{12}$/.test(s)||(r=!1,o="رقم الضمان الاجتماعي يجب أن يحتوي على 12 رقمًا بالضبط");break;case"montant_s":if(document.getElementById("categorie_sociale").value!=="عديم الدخل"){const _=parseFloat(s);isNaN(_)||_<=0?(r=!1,o="يرجى إدخال مبلغ صالح (أكبر من 0)"):n.value=_}else n.value="0",r=!0,d(n);break;case"num_cp":/^\d{10}$/.test(s)||(r=!1,o="رقم الحساب البريدي يجب أن يحتوي على 10 أرقام");break;case"cle_ccp":/^\d{2}$/.test(s)||(r=!1,o="الرقم المفتاح يجب أن يحتوي على رقمين اثنين");break;case"adresse":/^[\u0600-\u06FF\s]+$/.test(s)||(r=!1,o="يرجى الإدخال باللغة العربية فقط");break}return r?J(n):i?m(n,o):n.classList.remove("valid","invalid"),r}const R=document.getElementById("phone");R&&R.addEventListener("input",function(){const n=this.value.replace(/\D/g,"");this.value!==n?m(this,"يجب إدخال أرقام فقط"):n.length>0&&n.length!==10?m(this,"رقم الهاتف يجب أن يحتوي على 10 أرقام"):(d(this),this.classList.add("valid"),this.classList.remove("invalid")),this.value=n.slice(0,10)}),["nom_ar","prenom_ar","adresse"].forEach(n=>{const i=document.getElementById(n);if(!i)return;const s=/^[\u0600-\u06FF\s]+$/;i.addEventListener("keypress",function(e){const t=e.key;/^[\u0600-\u06FF\s]$/.test(t)||(e.preventDefault(),m(this,"يرجى الإدخال باللغة العربية فقط"),this.classList.add("invalid"),this.classList.remove("valid"))}),i.addEventListener("paste",function(e){e.preventDefault();const a=(e.clipboardData||window.clipboardData).getData("text").replace(/[^\u0600-\u06FF\s]/g,"");this.value=a,this.dispatchEvent(new Event("input"))}),i.addEventListener("input",function(){const e=this.value.trim();if(e===""){d(this),this.classList.remove("valid","invalid");return}s.test(e)?(d(this),this.classList.add("valid"),this.classList.remove("invalid")):(m(this,"يرجى الإدخال باللغة العربية فقط"),this.classList.add("invalid"),this.classList.remove("valid"))}),i.addEventListener("blur",function(){const e=this.value.trim();if(e===""){d(this),this.classList.remove("valid","invalid");return}s.test(e)||(m(this,"يرجى الإدخال باللغة العربية فقط"),this.classList.add("invalid"),this.classList.remove("valid"))})}),["nom_fr","prenom_fr"].forEach(n=>{const i=document.getElementById(n);if(!i)return;const s=/^[A-Za-zÀ-ÿ\s]+$/;i.addEventListener("keypress",function(e){const t=e.key;/^[\u0600-\u06FF]$/.test(t)&&(e.preventDefault(),m(this,"يرجى الإدخال بالحروف اللاتينية فقط"),this.classList.add("invalid"),this.classList.remove("valid"))}),i.addEventListener("input",function(){const e=this.value.trim();if(e===""){d(this),this.classList.remove("valid","invalid");return}s.test(e)?(d(this),this.classList.add("valid"),this.classList.remove("invalid")):(m(this,"يرجى الإدخال بالحروف اللاتينية فقط"),this.classList.add("invalid"),this.classList.remove("valid"))})});function W(){const n=document.querySelectorAll(".form-step.active input, .form-step.active select"),i=document.getElementById("categorie_sociale"),s=document.getElementById("montant_s"),e=document.getElementById("montant_s_wrapper");i&&s&&e&&(i._changeHandler&&i.removeEventListener("change",i._changeHandler),i._changeHandler=function(){const t=document.getElementById("certificate_of_none_income_wrapper"),a=document.getElementById("Certificate_of_none_income"),r=document.getElementById("certificate_of_non_affiliation_wrapper"),o=document.getElementById("Certificate_of_non_affiliation_to_social_security"),p=document.getElementById("crossed_ccp_wrapper"),l=document.getElementById("crossed_ccp");this.value==="الدخل الشهري أقل أو يساوي مبلغ الأجر الوطني الأدنى المضمون"?(e.style.display="block",s.removeAttribute("disabled"),s.setAttribute("required","required"),s.value="",p&&(p.style.display="block"),l&&l.setAttribute("required","required"),t&&(t.style.display="none"),a&&(a.removeAttribute("required"),a.value=""),r&&(r.style.display="none"),o&&(o.removeAttribute("required"),o.value="")):this.value==="عديم الدخل"?(e.style.display="none",s.value="",s.removeAttribute("required"),s.removeAttribute("disabled"),s.classList.remove("valid","invalid"),d(s),t&&(t.style.display="block"),a&&a.setAttribute("required","required"),r&&(r.style.display="block"),o&&o.setAttribute("required","required"),p&&(p.style.display="none"),l&&(l.removeAttribute("required"),l.value="")):(e.style.display="none",s.value="",s.removeAttribute("required"),s.removeAttribute("disabled"),s.classList.remove("valid","invalid"),d(s),t&&(t.style.display="none"),a&&(a.removeAttribute("required"),a.value=""),r&&(r.style.display="none"),o&&(o.removeAttribute("required"),o.value=""),p&&(p.style.display="none"),l&&(l.removeAttribute("required"),l.value=""))},i.addEventListener("change",i._changeHandler),i._changeHandler()),n.forEach(t=>{t.removeEventListener("input",t._inputHandler),t.removeEventListener("blur",t._blurHandler),t.id==="nin"&&t.addEventListener("input",()=>{t.value=t.value.replace(/\D/g,"").slice(0,18)}),t.id==="num_carte"&&t.addEventListener("input",()=>{t.value=t.value.replace(/\D/g,"").slice(0,9)}),t.id==="nss"&&t.addEventListener("input",()=>{t.value=t.value.replace(/\D/g,"").slice(0,12)}),t.id==="montant_s"&&t.addEventListener("input",()=>{parseFloat(t.value)<0&&(t.value="")}),t.id==="num_cp"&&t.addEventListener("input",()=>{t.value=t.value.replace(/\D/g,"").slice(0,10)}),t.id==="cle_ccp"&&t.addEventListener("input",()=>{t.value=t.value.replace(/\D/g,"").slice(0,2)}),t.id==="date_carte"?(t.addEventListener("change",()=>{t.value.trim()!==""&&A(t,!0)}),t._inputHandler=()=>{t.value.trim()!==""&&A(t,!0)}):t._inputHandler=()=>{t.value.trim()!==""&&A(t,!1)},t.addEventListener("input",t._inputHandler),t._blurHandler=()=>{t.value.trim()!==""&&A(t,!0)},t.addEventListener("blur",t._blurHandler)})}function X(){const n=document.getElementById("categorie_sociale"),i=document.getElementById("montant_s"),s=document.getElementById("montant_s_wrapper"),e=document.getElementById("certificate_of_none_income_wrapper"),t=document.getElementById("Certificate_of_none_income"),a=document.getElementById("certificate_of_non_affiliation_wrapper"),r=document.getElementById("Certificate_of_non_affiliation_to_social_security"),o=document.getElementById("crossed_ccp_wrapper"),p=document.getElementById("crossed_ccp");n&&i&&s&&(n.value==="عديم الدخل"||n.value===""?(s.style.display="none",i.value="",i.removeAttribute("required"),d(i),n.value==="عديم الدخل"?(e&&(e.style.display="block"),t&&t.setAttribute("required","required"),a&&(a.style.display="block"),r&&r.setAttribute("required","required")):(e&&(e.style.display="none"),t&&t.removeAttribute("required"),a&&(a.style.display="none"),r&&r.removeAttribute("required")),o&&(o.style.display="none"),p&&p.removeAttribute("required")):n.value==="الدخل الشهري أقل أو يساوي مبلغ الأجر الوطني الأدنى المضمون"&&(s.style.display="block",i.removeAttribute("disabled"),i.setAttribute("required","required"),i.value==="0"&&(i.value=""),o&&(o.style.display="block"),p&&p.setAttribute("required","required"),e&&(e.style.display="none"),t&&t.removeAttribute("required"),a&&(a.style.display="none"),r&&r.removeAttribute("required")))}function G(){const n=document.querySelector(".form-step.active"),i=n.querySelectorAll("input[required], select[required]");let s=!0,e=[];return n.querySelectorAll(".error-message").forEach(t=>t.remove()),i.forEach(t=>{const a=t.closest("#montant_s_wrapper");if(!(a&&window.getComputedStyle(a).display==="none")&&!A(t,!0)){s=!1;const r=t.closest(".form-group")?.querySelector("label")?.textContent||t.name;e.push(r)}}),i.forEach(t=>{if(!(t.disabled&&t.id!=="montant_s")&&!A(t,!0)){s=!1;const a=t.closest(".form-group")?.querySelector("label")?.textContent||t.name;e.includes(a)||e.push(a)}}),!s&&typeof Swal<"u"&&Swal.fire({icon:"warning",title:"يرجى إكمال البيانات",html:`الحقول التالية مطلوبة أو تحتوي على أخطاء:<br><b>${e.join("<br>")}</b>`,confirmButtonText:"حسنًا"}),s}K.forEach(n=>{n.addEventListener("click",()=>{(E===0||E===1)&&!G()||E<M.length-1&&(E++,$())})}),P.forEach(n=>{n.addEventListener("click",()=>{E>0&&(E--,$())})});const k=document.getElementById("signupForm");function z(n,i){if(n=n.trim(),i=i.trim(),!/^\d+$/.test(n)||!/^\d+$/.test(i))return!1;const e=parseInt(n,10)*100%97,a=(97-(e+85>97?e+85-97:e+85)).toString().padStart(2,"0");return i===a}k&&(k.noValidate=!0,k.addEventListener("submit",async n=>{n.preventDefault();let i=!0,s=[];document.querySelectorAll(".error-message").forEach(c=>c.remove()),k.querySelectorAll("input[required], select[required]").forEach(c=>{if(!A(c,!0)){i=!1;const y=c.closest(".form-group, .col-md-3")?.querySelector("label")?.textContent||c.name;s.includes(y)||s.push(y)}});const t=k.querySelector('input[name="gender"]:checked');t||(i=!1,s.includes("الجنس")||s.push("الجنس"));const a=document.getElementById("agreement_checkbox");!a||!a.checked?(i=!1,s.includes("الموافقة على القوانين")||s.push("الموافقة على القوانين"),a&&(a.style.outline="2px solid #ef4444",a.style.outlineOffset="2px")):a&&(a.style.outline="",a.style.outlineOffset="");const r=k.querySelectorAll('input[type="file"]'),o=["application/pdf","image/jpeg","image/jpg","image/png"],p=5*1024*1024;for(const c of r){const y=c.closest(".form-group");if(!(y&&window.getComputedStyle(y).display==="none")){if(c.hasAttribute("required")&&(!c.files||c.files.length===0)){i=!1;const _=y?.querySelector("label")?.textContent||c.name;s.includes(_)||s.push(_);continue}if(c.files&&c.files.length>0){const _=c.files[0];if(!o.includes(_.type)){i=!1;const T=y?.querySelector("label")?.textContent||c.name;m(c,"نوع الملف غير مسموح. يجب أن يكون PDF, JPG, JPEG, أو PNG"),s.includes(T)||s.push(T);continue}if(_.size>p){i=!1;const T=y?.querySelector("label")?.textContent||c.name;m(c,"حجم الملف كبير جداً. الحد الأقصى: 5 ميجابايت"),s.includes(T)||s.push(T);continue}d(c)}}}if(!i){Swal.fire({icon:"warning",title:"يرجى إكمال البيانات",html:`الحقول التالية مطلوبة أو تحتوي على أخطاء:<br><b>${s.join("<br>")}</b>`,confirmButtonText:"حسنًا"});return}const l=Object.fromEntries(new FormData(k).entries()),b={nin:l.nin,email:l.email,tel:l.phone,password:l.password,nom_ar:l.nom_ar,prenom_ar:l.prenom_ar,nom_fr:l.nom_fr,prenom_fr:l.prenom_fr,sexe:t.value==="male"?"ذكر":"أنثى",date_naiss:l.date_naissance,presume:l.presume?"1":"0",commune_naiss:document.getElementById("communeSelectSignup")?.value||null,adresse:l.adresse,nbr_enfants_scolarise:l.nbr_enfants,num_cni:l.num_carte,date_cni:l.date_carte,lieu_cni:document.getElementById("commune_carte")?.value||null,nss:l.nss,num_cpt:l.num_cp,cle_cpt:l.cle_ccp,cats:l.categorie_sociale,montant_s:l.categorie_sociale==="الدخل الشهري أقل أو يساوي مبلغ الأجر الوطني الأدنى المضمون"&&l.montant_s||null,autr_info:l.autre_info||"",code_commune:document.getElementById("communeSelectSignup")?.value||null};if(!z(b.num_cpt,b.cle_cpt)){Swal.fire({icon:"warning",title:" CCP خطأ في",text:"رقم CCP أو مفتاح CCP غير صحيح. يرجى التحقق.",confirmButtonText:"حسنًا"});return}const h=new FormData;for(const c in b)b[c]!==void 0&&b[c]!==null&&h.append(c,b[c]);["biometric_id","biometric_id_back","Certificate_of_none_income","Certificate_of_non_affiliation_to_social_security","crossed_ccp","salary_certificate"].forEach(c=>{const y=document.getElementById(c);y&&y.files&&y.files.length>0&&h.append(c,y.files[0])});try{Swal.fire({title:"جاري الإرسال...",text:"الرجاء الانتظار قليلاً",allowOutsideClick:!1,didOpen:()=>Swal.showLoading()});const c=await fetch("/api/tuteurs",{method:"POST",body:h,headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content,Accept:"application/json"}}),y=await c.json();if(Swal.close(),c.status===422){const _=Object.values(y.errors||{}).flat().join("<br>");Swal.fire({icon:"warning",title:"تحقق من البيانات",html:_,confirmButtonText:"حسنًا",customClass:{confirmButton:"swal-confirm-btn"},buttonsStyling:!1});return}if(!c.ok){Swal.fire({icon:"error",title:"حدث خطأ أثناء التسجيل",text:y.message||"يرجى المحاولة لاحقًا.",confirmButtonText:"حسنًا",customClass:{confirmButton:"swal-confirm-btn"},buttonsStyling:!1});return}Swal.fire({icon:"success",title:"✅ تم التسجيل بنجاح!",text:"يمكنك الآن تسجيل الدخول إلى حسابك.",confirmButtonText:"حسنًا",customClass:{confirmButton:"swal-confirm-btn"},buttonsStyling:!1}).then(()=>{window.location.href="/login"})}catch(c){console.error("❌ Fetch error:",c),Swal.close(),Swal.fire({icon:"error",title:"خطأ في الاتصال بالخادم",text:"تحقق من الاتصال بالخادم المحلي أو الشبكة."})}})),U(),W(),$()});document.querySelectorAll(".toggle-password").forEach(f=>{f.addEventListener("click",()=>{const u=f.closest(".password-wrapper").querySelector("input");u.type==="password"?(u.type="text",f.classList.replace("fa-eye","fa-eye-slash")):(u.type="password",f.classList.replace("fa-eye-slash","fa-eye"))})});window.toggleAgreementText=function(){const f=document.querySelector(".agreement-text-short"),u=document.querySelector(".agreement-text-full"),g=document.querySelector(".read-more-text"),v=document.querySelector(".read-less-text"),L=document.querySelector(".read-more-btn");f&&u&&g&&v&&L&&(u.style.display!=="none"&&u.style.display!==""?(f.style.display="block",u.style.display="none",g.style.display="inline",v.style.display="none",L.classList.remove("active")):(f.style.display="none",u.style.display="block",g.style.display="none",v.style.display="inline",L.classList.add("active")))};
