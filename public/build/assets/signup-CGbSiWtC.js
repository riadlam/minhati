function $(){document.querySelectorAll("#signupForm .form-group").forEach(d=>{const c=d.querySelector("input[required], select[required], textarea[required]"),v=d.querySelector("label");if(c&&!c.disabled&&v&&!v.querySelector(".text-danger")){const u=document.createElement("span");u.className="text-danger",u.textContent=" *",v.appendChild(u)}})}const T=new Date("2026-03-01T00:00:00");function F(){const d=document.getElementById("signupForm"),c=document.getElementById("deadlineAlert");if(!d)return;const u=new Date>=T;c&&c.classList.toggle("d-none",!u),u&&d.querySelectorAll("input, select, textarea, button").forEach(w=>{w.type!=="hidden"&&(w.disabled=!0)})}document.addEventListener("DOMContentLoaded",()=>{const d=document.getElementById("wilayaSelectSignup"),c=document.getElementById("communeSelectSignup");if(d&&c){async function t(){try{d.innerHTML='<option value="">جارٍ التحميل...</option>';const e=await(await fetch("/api/wilayas")).json(),n=Array.isArray(e)?e:e.data||[];d.innerHTML='<option value="">اختر...</option>',Array.isArray(n)&&n.forEach(o=>{d.innerHTML+=`<option value="${o.code_wil}">${o.lib_wil_ar}</option>`})}catch(a){console.error("خطأ في تحميل الولايات:",a),d.innerHTML='<option value="">تعذر تحميل البيانات</option>'}}async function s(a){try{c.innerHTML='<option value="">جارٍ التحميل...</option>',c.disabled=!0;const n=await(await fetch(`/api/communes/by-wilaya/${a}`)).json(),o=Array.isArray(n)?n:n.data||[];c.innerHTML='<option value="">اختر...</option>',Array.isArray(o)&&o.forEach(r=>{c.innerHTML+=`<option value="${r.code_comm}">${r.lib_comm_ar}</option>`}),c.disabled=!1}catch(e){console.error("خطأ في تحميل البلديات:",e),c.innerHTML='<option value="">تعذر تحميل البيانات</option>'}}d.addEventListener("change",a=>{const e=a.target.value;e?s(e):(c.innerHTML='<option value="">اختر الولاية أولا...</option>',c.disabled=!0)}),t()}const v=document.getElementById("wilaya_carte"),u=document.getElementById("commune_carte");if(v&&u){async function t(){try{v.innerHTML='<option value="">جارٍ التحميل...</option>';const e=await(await fetch("/api/wilayas")).json(),n=Array.isArray(e)?e:e.data||[];v.innerHTML='<option value="">-- اختر الولاية --</option>',Array.isArray(n)&&n.forEach(o=>v.innerHTML+=`<option value="${o.code_wil}">${o.lib_wil_ar}</option>`)}catch(a){console.error("خطأ في تحميل ولايات البطاقة:",a),v.innerHTML='<option value="">تعذر تحميل البيانات</option>'}}async function s(a){try{u.innerHTML='<option value="">جارٍ التحميل...</option>',u.disabled=!0;const n=await(await fetch(`/api/communes/by-wilaya/${a}`)).json(),o=Array.isArray(n)?n:n.data||[];u.innerHTML='<option value="">-- اختر البلدية --</option>',Array.isArray(o)&&o.forEach(r=>u.innerHTML+=`<option value="${r.code_comm}">${r.lib_comm_ar}</option>`),u.disabled=!1}catch(e){console.error("خطأ في تحميل بلديات البطاقة:",e),u.innerHTML='<option value="">تعذر تحميل البيانات</option>'}}v.addEventListener("change",a=>{const e=a.target.value;e?s(e):(u.innerHTML='<option value="">اختر الولاية أولا...</option>',u.disabled=!0)}),t()}$();const w=document.querySelectorAll(".form-step"),C=document.querySelectorAll(".next-step"),x=document.querySelectorAll(".prev-step"),B=document.getElementById("progress"),S=document.querySelectorAll(".progress-step");let h=0;function E(){w.forEach((t,s)=>t.classList.toggle("active",s===h)),S.forEach((t,s)=>t.classList.toggle("active",s<=h)),B.style.width=h/(S.length-1)*100+"%",q(),k()}function y(t,s){if(f(t),!s)return;const a=document.createElement("div");a.className="error-message",a.textContent=s,(t.closest(".password-wrapper")||t).insertAdjacentElement("afterend",a),t.classList.add("invalid"),t.classList.remove("valid")}function D(t){f(t),t.classList.add("valid"),t.classList.remove("invalid")}function f(t){(t.closest(".password-wrapper")||t).parentNode.querySelectorAll(".error-message").forEach(e=>e.remove())}function _(t,s=!0){if(t.disabled)return f(t),t.classList.remove("invalid","valid"),!0;const a=t.value.trim(),e=t.id,n=t.type,o=t.name;f(t);let r=!0,i="";if(n==="radio"){const b=document.querySelectorAll(`input[name="${o}"]`),l=document.querySelector(`input[name="${o}"]:checked`),p=t.closest(".form-group");if(p&&p.querySelectorAll(".error-message").forEach(m=>m.remove()),!l&&(r=!1,i="هذا الحقل مطلوب",s&&p)){const m=document.createElement("div");m.className="error-message",m.textContent=i,p.appendChild(m)}return b.forEach(m=>{m.classList.toggle("valid",r),m.classList.toggle("invalid",!r)}),r}if(t.tagName.toLowerCase()==="select"&&t.hasAttribute("required")&&(a===""||a==="none")&&(r=!1,i="هذا الحقل مطلوب"),t.hasAttribute("required")&&a===""&&(r=!1,i="هذا الحقل مطلوب"),r&&a!=="")switch(e){case"nin":/^\d{18}$/.test(a)||(r=!1,i="يجب أن يحتوي الرقم التعريفي الوطني على 18 رقمًا بالضبط");break;case"email":/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a)||(r=!1,i="البريد الإلكتروني غير صالح");break;case"phone":/^\d{10}$/.test(a)||(r=!1,i="رقم الهاتف يجب أن يحتوي على 10 أرقام");break;case"password":/^(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&]).{8,}$/.test(a)||(r=!1,i="كلمة المرور ضعيفة، يجب أن تحتوي على حرف كبير، رقم، ورمز خاص");break;case"confirm_password":const b=document.getElementById("password").value;a!==b&&(r=!1,i="كلمة المرور غير مطابقة");break;case"date_naissance":const l=new Date;new Date(a)>l&&(r=!1,i="تاريخ الميلاد لا يمكن أن يكون في المستقبل");break;case"num_carte":/^\d{9}$/.test(a)||(r=!1,i="يجب أن يحتوي رقم بطاقة التعريف الوطنية على 9 أرقام");break;case"date_carte":const m=new Date;m.setHours(0,0,0,0),new Date(a)>m&&(r=!1,i="تاريخ إصدار البطاقة يجب أن يكون قبل أو يساوي تاريخ اليوم");break;case"nss":/^\d{12}$/.test(a)||(r=!1,i="الرقم الوطني للضمان الاجتماعي يجب أن يحتوي على 12 رقمًا بالضبط");break;case"montant_s":if(document.getElementById("categorie_sociale").value!=="عديم الدخل"){const L=parseFloat(a);isNaN(L)||L<=0?(r=!1,i="يرجى إدخال مبلغ صالح (أكبر من 0)"):t.value=L}else t.value="0",r=!0,f(t);break;case"num_cp":/^\d{10}$/.test(a)||(r=!1,i="رقم الحساب البريدي يجب أن يحتوي على 10 أرقام");break;case"cle_ccp":/^\d{2}$/.test(a)||(r=!1,i="الرقم المفتاح يجب أن يحتوي على رقمين اثنين");break}return r?D(t):s?y(t,i):t.classList.remove("valid","invalid"),r}const A=document.getElementById("phone");A&&A.addEventListener("input",function(){const t=this.value.replace(/\D/g,"");this.value!==t?y(this,"يجب إدخال أرقام فقط"):t.length>0&&t.length!==10?y(this,"رقم الهاتف يجب أن يحتوي على 10 أرقام"):(f(this),this.classList.add("valid"),this.classList.remove("invalid")),this.value=t.slice(0,10)}),["nom_ar","prenom_ar"].forEach(t=>{const s=document.getElementById(t);if(!s)return;const a=/^[\u0600-\u06FF\s]+$/;s.addEventListener("keypress",function(e){const n=e.key;/^[\u0600-\u06FF\s]$/.test(n)||(e.preventDefault(),y(this,"يرجى الإدخال باللغة العربية فقط"),this.classList.add("invalid"),this.classList.remove("valid"))}),s.addEventListener("input",function(){const e=this.value.trim();if(e===""){f(this),this.classList.remove("valid","invalid");return}a.test(e)?(f(this),this.classList.add("valid"),this.classList.remove("invalid")):(y(this,"يرجى الإدخال باللغة العربية فقط"),this.classList.add("invalid"),this.classList.remove("valid"))})}),["nom_fr","prenom_fr"].forEach(t=>{const s=document.getElementById(t);if(!s)return;const a=/^[A-Za-zÀ-ÿ\s]+$/;s.addEventListener("keypress",function(e){const n=e.key;/^[\u0600-\u06FF]$/.test(n)&&(e.preventDefault(),y(this,"يرجى الإدخال بالحروف اللاتينية فقط"),this.classList.add("invalid"),this.classList.remove("valid"))}),s.addEventListener("input",function(){const e=this.value.trim();if(e===""){f(this),this.classList.remove("valid","invalid");return}a.test(e)?(f(this),this.classList.add("valid"),this.classList.remove("invalid")):(y(this,"يرجى الإدخال بالحروف اللاتينية فقط"),this.classList.add("invalid"),this.classList.remove("valid"))})});function q(){const t=document.querySelectorAll(".form-step.active input, .form-step.active select"),s=document.getElementById("categorie_sociale"),a=document.getElementById("montant_s");s&&a&&(s.removeEventListener("change",s._changeHandler),s._changeHandler=function(){this.value==="1"?(a.removeAttribute("disabled"),a.setAttribute("required","required"),a.value=""):(a.value="0",a.setAttribute("disabled","disabled"),a.removeAttribute("required"),a.classList.remove("valid","invalid"),f(a))},s.addEventListener("change",s._changeHandler),s._changeHandler()),t.forEach(e=>{e.removeEventListener("input",e._inputHandler),e.removeEventListener("blur",e._blurHandler),e.id==="nin"&&e.addEventListener("input",()=>{e.value=e.value.replace(/\D/g,"").slice(0,18)}),e.id==="num_carte"&&e.addEventListener("input",()=>{e.value=e.value.replace(/\D/g,"").slice(0,9)}),e.id==="nss"&&e.addEventListener("input",()=>{e.value=e.value.replace(/\D/g,"").slice(0,12)}),e.id==="montant_s"&&e.addEventListener("input",()=>{parseFloat(e.value)<0&&(e.value="")}),e.id==="num_cp"&&e.addEventListener("input",()=>{e.value=e.value.replace(/\D/g,"").slice(0,10)}),e.id==="cle_ccp"&&e.addEventListener("input",()=>{e.value=e.value.replace(/\D/g,"").slice(0,2)}),e._inputHandler=()=>{e.value.trim()!==""&&_(e,!1)},e.addEventListener("input",e._inputHandler),e._blurHandler=()=>{e.value.trim()!==""&&_(e,!0)},e.addEventListener("blur",e._blurHandler)})}function k(){const t=document.getElementById("categorie_sociale"),s=document.getElementById("montant_s");t.value==="2"||t.value===""?(s.value="0",s.setAttribute("disabled",!0),s.removeAttribute("required"),f(s)):(s.removeAttribute("disabled"),s.setAttribute("required","required"),s.value==="0"&&(s.value=""))}function I(){const t=document.querySelector(".form-step.active"),s=t.querySelectorAll("input[required], select[required]");let a=!0,e=[];return t.querySelectorAll(".error-message").forEach(n=>n.remove()),s.forEach(n=>{if(!_(n,!0)){a=!1;const o=n.closest(".form-group")?.querySelector("label")?.textContent||n.name;e.push(o)}}),s.forEach(n=>{if(!(n.disabled&&n.id!=="montant_s")&&!_(n,!0)){a=!1;const o=n.closest(".form-group")?.querySelector("label")?.textContent||n.name;e.includes(o)||e.push(o)}}),!a&&typeof Swal<"u"&&Swal.fire({icon:"warning",title:"يرجى إكمال البيانات",html:`الحقول التالية مطلوبة أو تحتوي على أخطاء:<br><b>${e.join("<br>")}</b>`,confirmButtonText:"حسنًا"}),a}C.forEach(t=>{t.addEventListener("click",()=>{(h===0||h===1)&&!I()||h<w.length-1&&(h++,E())})}),x.forEach(t=>{t.addEventListener("click",()=>{h>0&&(h--,E())})});const g=document.getElementById("signupForm");function H(t,s){if(t=t.trim(),s=s.trim(),!/^\d+$/.test(t)||!/^\d+$/.test(s))return!1;const e=parseInt(t,10)*100%97,o=(97-(e+85>97?e+85-97:e+85)).toString().padStart(2,"0");return s===o}g&&(g.noValidate=!0,g.addEventListener("submit",async t=>{t.preventDefault();let s=!0,a=[];document.querySelectorAll(".error-message").forEach(l=>l.remove()),g.querySelectorAll("input[required], select[required]").forEach(l=>{if(!_(l,!0)){s=!1;const p=l.closest(".form-group, .col-md-3")?.querySelector("label")?.textContent||l.name;a.includes(p)||a.push(p)}});const n=g.querySelector('input[name="gender"]:checked');n||(s=!1,a.includes("الجنس")||a.push("الجنس"));const o=document.getElementById("agreement_checkbox");if(!o||!o.checked?(s=!1,a.includes("الموافقة على القوانين")||a.push("الموافقة على القوانين"),o&&(o.style.outline="2px solid #ef4444",o.style.outlineOffset="2px")):o&&(o.style.outline="",o.style.outlineOffset=""),!s){Swal.fire({icon:"warning",title:"يرجى إكمال البيانات",html:`الحقول التالية مطلوبة أو تحتوي على أخطاء:<br><b>${a.join("<br>")}</b>`,confirmButtonText:"حسنًا"});return}const r=Object.fromEntries(new FormData(g).entries()),i={nin:r.nin,email:r.email,tel:r.phone,password:r.password,nom_ar:r.nom_ar,prenom_ar:r.prenom_ar,nom_fr:r.nom_fr,prenom_fr:r.prenom_fr,sexe:n.value==="male"?"ذكر":"أنثى",date_naiss:r.date_naissance,presume:r.presume?"1":"0",commune_naiss:document.getElementById("communeSelectSignup")?.value||null,adresse:r.adresse,nbr_enfants_scolarise:r.nbr_enfants,num_cni:r.num_carte,date_cni:r.date_carte,lieu_cni:document.getElementById("commune_carte")?.value||null,nss:r.nss,num_cpt:r.num_cp,cle_cpt:r.cle_ccp,cats:r.categorie_sociale,montant_s:r.montant_s,autr_info:r.autre_info||"",code_commune:document.getElementById("communeSelectSignup")?.value||null};if(!H(i.num_cpt,i.cle_cpt)){Swal.fire({icon:"warning",title:" CCP خطأ في",text:"رقم CCP أو مفتاح CCP غير صحيح. يرجى التحقق.",confirmButtonText:"حسنًا"});return}const b=new FormData;for(const l in i)i[l]!==void 0&&i[l]!==null&&b.append(l,i[l]);try{Swal.fire({title:"جاري الإرسال...",text:"الرجاء الانتظار قليلاً",allowOutsideClick:!1,didOpen:()=>Swal.showLoading()});const l=await fetch("/api/tuteurs",{method:"POST",body:b,headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content,Accept:"application/json"}}),p=await l.json();if(Swal.close(),l.status===422){const m=Object.values(p.errors||{}).flat().join("<br>");Swal.fire({icon:"warning",title:"تحقق من البيانات",html:m,confirmButtonText:"حسنًا",customClass:{confirmButton:"swal-confirm-btn"},buttonsStyling:!1});return}if(!l.ok){Swal.fire({icon:"error",title:"حدث خطأ أثناء التسجيل",text:p.message||"يرجى المحاولة لاحقًا.",confirmButtonText:"حسنًا",customClass:{confirmButton:"swal-confirm-btn"},buttonsStyling:!1});return}Swal.fire({icon:"success",title:"✅ تم التسجيل بنجاح!",text:"يمكنك الآن تسجيل الدخول إلى حسابك.",confirmButtonText:"حسنًا",customClass:{confirmButton:"swal-confirm-btn"},buttonsStyling:!1}).then(()=>{window.location.href="/login"})}catch(l){console.error("❌ Fetch error:",l),Swal.close(),Swal.fire({icon:"error",title:"خطأ في الاتصال بالخادم",text:"تحقق من الاتصال بالخادم المحلي أو الشبكة."})}})),F(),q(),E()});document.querySelectorAll(".toggle-password").forEach(d=>{d.addEventListener("click",()=>{const c=d.closest(".password-wrapper").querySelector("input");c.type==="password"?(c.type="text",d.classList.replace("fa-eye","fa-eye-slash")):(c.type="password",d.classList.replace("fa-eye-slash","fa-eye"))})});
